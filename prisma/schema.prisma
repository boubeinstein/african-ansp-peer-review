generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id               String            @id @default(cuid())
  nameEn           String            @map("name_en")
  nameFr           String            @map("name_fr")
  icaoCode         String?           @unique @map("icao_code")
  country          String
  region           AfricanRegion
  city             String?
  peerReviewTeam   Int?              @map("peer_review_team")
  membershipStatus MembershipStatus  @default(PENDING)
  joinedAt         DateTime?         @map("joined_at")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  // Relations
  assessments      Assessment[]
  documents        Document[]
  findings         Finding[]
  reviewsAsHost    Review[]          @relation("HostANSP")
  users            User[]
  // Reviewer-related relations
  homeReviewers    ReviewerProfile[] @relation("HomeReviewers")
  conflictCOIs     ReviewerCOI[]     @relation("ConflictReviewers")
  coiOverrides     COIOverride[]     @relation("COIOverrides")

  @@map("organizations")
}

model User {
  id                     String                 @id @default(cuid())
  email                  String                 @unique
  passwordHash           String?                @map("password_hash")
  emailVerified          DateTime?              @map("email_verified")
  firstName              String                 @map("first_name")
  lastName               String                 @map("last_name")
  title                  String?
  phone                  String?
  locale                 Locale                 @default(EN)
  timezone               String                 @default("UTC")
  theme                  Theme                  @default(SYSTEM)
  role                   UserRole               @default(STAFF)
  organizationId         String?                @map("organization_id")
  lastLoginAt            DateTime?              @map("last_login_at")
  isActive               Boolean                @default(true) @map("is_active")
  createdAt              DateTime               @default(now()) @map("created_at")
  updatedAt              DateTime               @updatedAt @map("updated_at")
  assessmentResponses    AssessmentResponse[]
  auditLogs              AuditLog[]
  assignedCAPs           CorrectiveActionPlan[] @relation("AssignedTo")
  assignedFindings       Finding[]              @relation("AssignedTo")
  notifications          Notification[]
  reviewTeamMembers      ReviewTeamMember[]
  reviewerProfile        ReviewerProfile?
  organization           Organization?          @relation(fields: [organizationId], references: [id])
  uploadedDocuments      Document[]             @relation("UploadedDocuments")
  addedResponseDocuments ResponseDocument[]     @relation("AddedResponseDocuments")
  assessmentEvents       AssessmentEvent[]

  // === COI Relations ===
  createdCOIs            ReviewerCOI[]          @relation("COICreator")
  verifiedCOIs           ReviewerCOI[]          @relation("COIVerifier")
  approvedCOIOverrides   COIOverride[]          @relation("COIOverrideApprover")
  revokedCOIOverrides    COIOverride[]          @relation("COIOverrideRevoker")

  // === Availability Relations ===
  createdAvailabilitySlots ReviewerAvailability[] @relation("AvailabilityCreator")

  @@map("users")
}

model Questionnaire {
  id            String                  @id @default(cuid())
  code          String                  @unique
  type          QuestionnaireType
  version       String
  titleEn       String                  @map("title_en")
  titleFr       String                  @map("title_fr")
  descriptionEn String?                 @map("description_en")
  descriptionFr String?                 @map("description_fr")
  effectiveDate DateTime                @map("effective_date")
  expiryDate    DateTime?               @map("expiry_date")
  isActive      Boolean                 @default(true) @map("is_active")
  createdAt     DateTime                @default(now()) @map("created_at")
  updatedAt     DateTime                @updatedAt @map("updated_at")
  assessments   Assessment[]
  categories    QuestionnaireCategory[]
  questions     Question[]

  @@map("questionnaires")
}

model QuestionnaireCategory {
  id              String           @id @default(cuid())
  questionnaireId String           @map("questionnaire_id")
  code            String
  sortOrder       Int              @map("sort_order")
  nameEn          String           @map("name_en")
  nameFr          String           @map("name_fr")
  descriptionEn   String?          @map("description_en")
  descriptionFr   String?          @map("description_fr")
  auditArea       USOAPAuditArea?  @map("audit_area")
  criticalElement CriticalElement? @map("critical_element")
  smsComponent    SMSComponent?    @map("sms_component")
  studyArea       CANSOStudyArea?  @map("study_area")
  transversalArea TransversalArea? @map("transversal_area")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  questionnaire   Questionnaire    @relation(fields: [questionnaireId], references: [id])
  questions       Question[]

  @@unique([questionnaireId, code])
  @@map("questionnaire_categories")
}

model Question {
  id               String                @id @default(cuid())
  questionnaireId  String                @map("questionnaire_id")
  categoryId       String                @map("category_id")
  pqNumber         String?               @map("pq_number")
  auditArea        USOAPAuditArea?       @map("audit_area")
  criticalElement  CriticalElement?      @map("critical_element")
  isPriorityPQ     Boolean               @default(false) @map("is_priority_pq")
  requiresOnSite   Boolean               @default(false) @map("requires_on_site")
  pqStatus         PQAmendmentStatus     @default(NO_CHANGE) @map("pq_status")
  previousPqNumber String?               @map("previous_pq_number")
  smsComponent     SMSComponent?         @map("sms_component")
  studyArea        CANSOStudyArea?       @map("study_area")
  maturityLevel    MaturityLevel?        @map("maturity_level")
  questionTextEn   String                @map("question_text_en")
  questionTextFr   String                @map("question_text_fr")
  guidanceEn       String?               @map("guidance_en")
  guidanceFr       String?               @map("guidance_fr")
  responseType     ResponseType          @default(SATISFACTORY_NOT)
  requiredEvidence String[]              @default([])
  weight           Float                 @default(1.0)
  maxScore         Float                 @default(1.0) @map("max_score")
  sortOrder        Int                   @map("sort_order")
  isActive         Boolean               @default(true) @map("is_active")
  createdAt        DateTime              @default(now()) @map("created_at")
  updatedAt        DateTime              @updatedAt @map("updated_at")
  responses        AssessmentResponse[]
  findings         Finding[]
  icaoReferences   ICAOReference[]
  category         QuestionnaireCategory @relation(fields: [categoryId], references: [id])
  questionnaire    Questionnaire         @relation(fields: [questionnaireId], references: [id])

  @@unique([questionnaireId, pqNumber])
  @@index([auditArea, criticalElement])
  @@index([smsComponent, studyArea])
  @@map("questions")
}

model ICAOReference {
  id            String            @id @default(cuid())
  questionId    String            @map("question_id")
  referenceType ICAOReferenceType @map("reference_type")
  document      String
  chapter       String?
  description   String?
  question      Question          @relation(fields: [questionId], references: [id])

  @@map("icao_references")
}

model ReviewerProfile {
  id                     String                  @id @default(cuid())
  userId                 String                  @unique @map("user_id")
  organizationId         String                  @map("organization_id")
  homeOrganizationId     String                  @map("home_organization_id")
  status                 ReviewerStatus          @default(NOMINATED)
  selectionStatus        ReviewerSelectionStatus @default(NOMINATED) @map("selection_status")
  reviewerType           ReviewerType            @default(PEER_REVIEWER) @map("reviewer_type")
  nominatedAt            DateTime?               @map("nominated_at")
  selectedAt             DateTime?               @map("selected_at")
  certifiedAt            DateTime?               @map("certified_at")
  currentPosition        String                  @map("current_position")
  yearsExperience        Int                     @map("years_experience")
  biography              String?
  biographyFr            String?                 @map("biography_fr")
  expertiseAreas         ExpertiseArea[]         @default([])
  specializations        String[]                @default([])
  isLeadQualified        Boolean                 @default(false) @map("is_lead_qualified")
  leadQualifiedAt        DateTime?               @map("lead_qualified_at")
  reviewsCompleted       Int                     @default(0) @map("reviews_completed")
  reviewsAsLead          Int                     @default(0) @map("reviews_as_lead")
  lastReviewDate         DateTime?               @map("last_review_date")
  isAvailable            Boolean                 @default(true) @map("is_available")
  availableFrom          DateTime?               @map("available_from")
  availableTo            DateTime?               @map("available_to")
  conflictOrganizations  String[]                @default([]) @map("conflict_organizations")
  averageRating          Float?                  @map("average_rating")
  feedbackCount          Int                     @default(0) @map("feedback_count")
  // Contact preferences
  preferredContactMethod ContactMethod           @default(EMAIL) @map("preferred_contact_method")
  alternativeEmail       String?                 @map("alternative_email")
  alternativePhone       String?                 @map("alternative_phone")
  // Travel information
  passportCountry        String?                 @map("passport_country")
  visaCountries          String[]                @default([]) @map("visa_countries")
  travelRestrictions     String?                 @map("travel_restrictions")
  // Timestamps
  createdAt              DateTime                @default(now()) @map("created_at")
  updatedAt              DateTime                @updatedAt @map("updated_at")
  // Relations
  user                   User                    @relation(fields: [userId], references: [id])
  homeOrganization       Organization            @relation("HomeReviewers", fields: [homeOrganizationId], references: [id])
  teamAssignments        ReviewTeamMember[]
  certifications         ReviewerCertification[]
  languages              ReviewerLanguage[]
  trainingRecords        ReviewerTraining[]
  expertiseRecords       ReviewerExpertise[]
  availabilityPeriods    ReviewerAvailability[]
  conflictsOfInterest    ReviewerCOI[]
  coiOverrides           COIOverride[]

  @@index([homeOrganizationId])
  @@index([selectionStatus, reviewerType])
  @@index([isAvailable, selectionStatus])
  @@map("reviewer_profiles")
}

model ReviewerLanguage {
  id String @id @default(cuid())

  // === Parent ===
  reviewerProfileId String          @map("reviewer_profile_id")
  reviewerProfile   ReviewerProfile @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  // === Language Details ===
  language    Language
  proficiency LanguageProficiency
  isNative    Boolean             @default(false) @map("is_native")

  // === ICAO Language Proficiency (for aviation context) ===
  icaoLevel          Int?      @map("icao_level") // 1-6 ICAO scale
  icaoAssessmentDate DateTime? @map("icao_assessment_date")
  icaoExpiryDate     DateTime? @map("icao_expiry_date")

  // === Work capability ===
  canWriteReports      Boolean @default(false) @map("can_write_reports")
  canConductInterviews Boolean @default(false) @map("can_conduct_interviews")

  @@unique([reviewerProfileId, language])
  @@index([reviewerProfileId])
  @@map("reviewer_languages")
}

// ============================================
// REVIEWER CERTIFICATIONS
// ============================================

model ReviewerCertification {
  id String @id @default(cuid())

  // === Parent ===
  reviewerProfileId String          @map("reviewer_profile_id")
  reviewerProfile   ReviewerProfile @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  // === Certification Details ===
  certificationType   CertificationType @map("certification_type")
  certificationName   String            @map("certification_name")
  certificationNameFr String?           @map("certification_name_fr")
  issuingAuthority    String            @map("issuing_authority")

  // === Validity Period ===
  issueDate  DateTime  @map("issue_date")
  expiryDate DateTime? @map("expiry_date")
  isValid    Boolean   @default(true) @map("is_valid")

  // === Documentation ===
  certificateNumber String? @map("certificate_number")
  documentUrl       String? @map("document_url")

  // === Metadata ===
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([reviewerProfileId])
  @@index([certificationType])
  @@index([expiryDate])
  @@map("reviewer_certifications")
}

// ============================================
// REVIEWER TRAINING RECORDS
// ============================================

model ReviewerTraining {
  id String @id @default(cuid())

  // === Parent ===
  reviewerProfileId String          @map("reviewer_profile_id")
  reviewerProfile   ReviewerProfile @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  // === Training Details ===
  trainingType   TrainingType @map("training_type")
  trainingName   String       @map("training_name")
  trainingNameFr String?      @map("training_name_fr")
  provider       String

  // === Completion ===
  startDate      DateTime       @map("start_date")
  completionDate DateTime?      @map("completion_date")
  status         TrainingStatus @default(SCHEDULED)

  // === Details ===
  location       String?
  isOnline       Boolean @default(false) @map("is_online")
  hoursCompleted Int?    @map("hours_completed")
  grade          String?

  // === Documentation ===
  certificateUrl String? @map("certificate_url")
  notes          String? @db.Text

  // === Metadata ===
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([reviewerProfileId])
  @@index([trainingType])
  @@index([status])
  @@map("reviewer_trainings")
}

// ============================================
// REVIEWER PROFILE MODULE - NEW MODELS
// ============================================

model ReviewerExpertise {
  id String @id @default(cuid())

  // === Parent ===
  reviewerProfileId String          @map("reviewer_profile_id")
  reviewerProfile   ReviewerProfile @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  // === Expertise Details ===
  area             ExpertiseArea
  proficiencyLevel ProficiencyLevel @default(COMPETENT) @map("proficiency_level")
  yearsExperience  Int              @default(0) @map("years_experience")

  // === Verification ===
  isVerified Boolean   @default(false) @map("is_verified")
  verifiedAt DateTime? @map("verified_at")
  verifiedBy String?   @map("verified_by")

  // === Supporting information ===
  description    String?
  descriptionFr  String?  @map("description_fr")
  certifications String[] @default([])

  // === For questionnaire matching ===
  canAssessANS Boolean @default(false) @map("can_assess_ans")
  canAssessSMS Boolean @default(false) @map("can_assess_sms")

  // === Metadata ===
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([reviewerProfileId, area])
  @@index([area, proficiencyLevel])
  @@map("reviewer_expertises")
}

// ============================================
// REVIEWER AVAILABILITY
// ============================================

model ReviewerAvailability {
  id String @id @default(cuid())

  // === Parent ===
  reviewerProfileId String          @map("reviewer_profile_id")
  reviewerProfile   ReviewerProfile @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  // === Time Period ===
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")

  // === Availability Type ===
  availabilityType AvailabilityType @default(AVAILABLE) @map("availability_type")

  // === Details ===
  title             String? // e.g., "Annual Leave", "ICAO Training"
  notes             String? @db.Text
  isRecurring       Boolean @default(false) @map("is_recurring")
  recurrencePattern String? @map("recurrence_pattern") // RRULE format

  // === If blocked by a review assignment ===
  reviewId String?  @map("review_id")
  review   Review?  @relation(fields: [reviewId], references: [id])

  // === Creator ===
  createdById String? @map("created_by_id")
  createdBy   User?   @relation("AvailabilityCreator", fields: [createdById], references: [id])

  // === Metadata ===
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([reviewerProfileId])
  @@index([startDate, endDate])
  @@index([availabilityType])
  @@index([reviewId])
  @@map("reviewer_availability")
}

// ============================================
// CONFLICT OF INTEREST TRACKING
// Per ICAO Doc 9734 and programme COI policy
// ============================================

model ReviewerCOI {
  id String @id @default(cuid())

  // === Reviewer ===
  reviewerProfileId String          @map("reviewer_profile_id")
  reviewerProfile   ReviewerProfile @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  // === Conflicting Organization ===
  organizationId String       @map("organization_id")
  organization   Organization @relation("ConflictReviewers", fields: [organizationId], references: [id])

  // === COI Details ===
  coiType  COIType     @map("coi_type")
  severity COISeverity @default(SOFT_WARNING) @map("severity")
  reason   String?     @db.Text // Legacy field
  reasonEn String?     @map("reason_en") @db.Text
  reasonFr String?     @map("reason_fr") @db.Text

  // === Validity Period ===
  startDate DateTime  @default(now()) @map("start_date")
  endDate   DateTime? @map("end_date") // null = indefinite
  isActive  Boolean   @default(true) @map("is_active")

  // === Auto-Detection ===
  isAutoDetected Boolean   @default(false) @map("is_auto_detected")
  autoDetectedAt DateTime? @map("auto_detected_at")

  // === Creator & Verification ===
  createdById       String?   @map("created_by_id")
  createdBy         User?     @relation("COICreator", fields: [createdById], references: [id])
  verifiedById      String?   @map("verified_by_id")
  verifiedBy        User?     @relation("COIVerifier", fields: [verifiedById], references: [id])
  verifiedAt        DateTime? @map("verified_at")
  verificationNotes String?   @map("verification_notes") @db.Text

  // === Metadata ===
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([reviewerProfileId, organizationId, coiType])
  @@index([organizationId])
  @@index([isActive])
  @@index([severity])
  @@index([isAutoDetected])
  @@map("reviewer_coi")
}

// ============================================
// COI OVERRIDE (for soft warnings only)
// Allows admin to override soft warning COIs with documented justification
// ============================================

model COIOverride {
  id String @id @default(cuid())

  // === Reviewer & Organization ===
  reviewerProfileId String          @map("reviewer_profile_id")
  reviewerProfile   ReviewerProfile @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)
  organizationId    String          @map("organization_id")
  organization      Organization    @relation("COIOverrides", fields: [organizationId], references: [id])

  // === Optional: Specific Review Context ===
  reviewId String?  @map("review_id")
  review   Review?  @relation(fields: [reviewId], references: [id])

  // === Override Details ===
  justification String @db.Text // Min 50 chars, documented reason

  // === Approval ===
  approvedById String   @map("approved_by_id")
  approvedBy   User     @relation("COIOverrideApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime @default(now()) @map("approved_at")

  // === Expiration ===
  expiresAt DateTime? @map("expires_at") // null = no expiration

  // === Revocation ===
  isRevoked    Boolean   @default(false) @map("is_revoked")
  revokedAt    DateTime? @map("revoked_at")
  revokedById  String?   @map("revoked_by_id")
  revokedBy    User?     @relation("COIOverrideRevoker", fields: [revokedById], references: [id])
  revokeReason String?   @map("revoke_reason") @db.Text

  // === Metadata ===
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([reviewerProfileId, organizationId, reviewId])
  @@index([organizationId])
  @@index([approvedById])
  @@index([isRevoked])
  @@map("coi_override")
}

model Assessment {
  id              String               @id @default(cuid())
  referenceNumber String?              @unique @map("reference_number")
  type            AssessmentType       @default(SELF_ASSESSMENT)
  title           String
  description     String?
  questionnaireId String               @map("questionnaire_id")
  organizationId  String               @map("organization_id")

  // Selected audit areas for this assessment
  // When empty, ALL audit areas are included; when populated, only these areas count
  selectedAuditAreas USOAPAuditArea[]  @default([]) @map("selected_audit_areas")

  status          AssessmentStatus     @default(DRAFT)
  progress        Float                @default(0)
  dueDate         DateTime?            @map("due_date")
  startedAt       DateTime?            @map("started_at")
  submittedAt     DateTime?            @map("submitted_at")
  completedAt     DateTime?            @map("completed_at")
  overallScore    Float?               @map("overall_score")
  maturityLevel   MaturityLevel?       @map("maturity_level")
  eiScore         Float?               @map("ei_score")
  categoryScores  Json?                @map("category_scores")
  reviewId        String?              @map("review_id")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  responses       AssessmentResponse[]
  events          AssessmentEvent[]
  organization    Organization         @relation(fields: [organizationId], references: [id])
  questionnaire   Questionnaire        @relation(fields: [questionnaireId], references: [id])
  review          Review?              @relation(fields: [reviewId], references: [id])
  documents       Document[]

  @@index([organizationId, questionnaireId])
  @@map("assessments")
}

model AssessmentEvent {
  id           String    @id @default(cuid())
  assessmentId String    @map("assessment_id")
  type         EventType
  description  String
  metadata     Json?
  userId       String    @map("user_id")
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])

  @@index([assessmentId, createdAt])
  @@map("assessment_events")
}

model AssessmentResponse {
  id            String         @id @default(cuid())
  assessmentId  String         @map("assessment_id")
  questionId    String         @map("question_id")
  responseValue String?        @map("response_value")
  maturityLevel MaturityLevel? @map("maturity_level")
  score         Float?
  notes         String?
  evidenceUrls  String[]       @default([]) @map("evidence_urls")
  respondedById String?        @map("responded_by_id")
  respondedAt   DateTime?      @map("responded_at")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  // Relations
  assessment  Assessment         @relation(fields: [assessmentId], references: [id])
  question    Question           @relation(fields: [questionId], references: [id])
  respondedBy User?              @relation(fields: [respondedById], references: [id])
  documents   ResponseDocument[]

  @@unique([assessmentId, questionId])
  @@map("assessment_responses")
}

model Review {
  id                    String                 @id @default(cuid())
  referenceNumber       String                 @unique @map("reference_number")
  reviewType            ReviewType             @default(FULL)
  locationType          ReviewLocationType     @default(ON_SITE) @map("location_type")
  hostOrganizationId    String                 @map("host_organization_id")
  status                ReviewStatus           @default(REQUESTED)
  phase                 ReviewPhase            @default(PLANNING)
  requestedDate         DateTime               @map("requested_date")
  requestedStartDate    DateTime?              @map("requested_start_date")
  requestedEndDate      DateTime?              @map("requested_end_date")
  plannedStartDate      DateTime?              @map("planned_start_date")
  plannedEndDate        DateTime?              @map("planned_end_date")
  actualStartDate       DateTime?              @map("actual_start_date")
  actualEndDate         DateTime?              @map("actual_end_date")
  objectives            String?                @db.Text
  specialRequirements   String?                @map("special_requirements") @db.Text
  questionnairesInScope String[]               @default([]) @map("questionnaires_in_scope")
  areasInScope          String[]               @default([]) @map("areas_in_scope")
  // Logistics
  accommodationProvided Boolean                @default(false) @map("accommodation_provided")
  transportationProvided Boolean               @default(false) @map("transportation_provided")
  languagePreference    LanguagePreference     @default(BOTH) @map("language_preference")
  // Primary contact
  primaryContactName    String?                @map("primary_contact_name")
  primaryContactEmail   String?                @map("primary_contact_email")
  primaryContactPhone   String?                @map("primary_contact_phone")
  // Timestamps
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  // Relations
  assessments           Assessment[]
  documents             Document[]
  findings              Finding[]
  report                ReviewReport?
  teamMembers           ReviewTeamMember[]
  hostOrganization      Organization           @relation("HostANSP", fields: [hostOrganizationId], references: [id])
  coiOverrides          COIOverride[]
  blockedAvailability   ReviewerAvailability[]

  @@map("reviews")
}

model ReviewTeamMember {
  id                String           @id @default(cuid())
  reviewId          String           @map("review_id")
  userId            String           @map("user_id")
  reviewerProfileId String?          @map("reviewer_profile_id")
  role              TeamRole         @default(REVIEWER)
  assignedAreas     String[]         @default([]) @map("assigned_areas")
  confirmedAt       DateTime?        @map("confirmed_at")
  declinedAt        DateTime?        @map("declined_at")
  declineReason     String?          @map("decline_reason")
  createdAt         DateTime         @default(now()) @map("created_at")
  review            Review           @relation(fields: [reviewId], references: [id])
  reviewerProfile   ReviewerProfile? @relation(fields: [reviewerProfileId], references: [id])
  user              User             @relation(fields: [userId], references: [id])

  @@unique([reviewId, userId])
  @@map("review_team_members")
}

model ReviewReport {
  id                 String         @id @default(cuid())
  reviewId           String         @unique @map("review_id")
  titleEn            String         @map("title_en")
  titleFr            String         @map("title_fr")
  executiveSummaryEn String?        @map("executive_summary_en")
  executiveSummaryFr String?        @map("executive_summary_fr")
  overallMaturity    MaturityLevel? @map("overall_maturity")
  overallEI          Float?         @map("overall_ei")
  status             String         @default("DRAFT")
  draftedAt          DateTime?      @map("drafted_at")
  reviewedAt         DateTime?      @map("reviewed_at")
  finalizedAt        DateTime?      @map("finalized_at")
  pdfUrl             String?        @map("pdf_url")
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")
  review             Review         @relation(fields: [reviewId], references: [id])

  @@map("review_reports")
}

model Finding {
  id                   String                @id @default(cuid())
  reviewId             String                @map("review_id")
  organizationId       String                @map("organization_id")
  questionId           String?               @map("question_id")
  referenceNumber      String                @unique @map("reference_number")
  findingType          FindingType           @default(OBSERVATION)
  severity             FindingSeverity       @default(MINOR)
  titleEn              String                @map("title_en")
  titleFr              String                @map("title_fr")
  descriptionEn        String                @map("description_en")
  descriptionFr        String                @map("description_fr")
  evidenceEn           String?               @map("evidence_en")
  evidenceFr           String?               @map("evidence_fr")
  icaoReference        String?               @map("icao_reference")
  criticalElement      CriticalElement?      @map("critical_element")
  status               FindingStatus         @default(OPEN)
  assignedToId         String?               @map("assigned_to_id")
  capRequired          Boolean               @default(true) @map("cap_required")
  identifiedAt         DateTime              @default(now()) @map("identified_at")
  targetCloseDate      DateTime?             @map("target_close_date")
  closedAt             DateTime?             @map("closed_at")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  correctiveActionPlan CorrectiveActionPlan?
  documents            Document[]
  assignedTo           User?                 @relation("AssignedTo", fields: [assignedToId], references: [id])
  organization         Organization          @relation(fields: [organizationId], references: [id])
  question             Question?             @relation(fields: [questionId], references: [id])
  review               Review                @relation(fields: [reviewId], references: [id])

  @@index([reviewId, status])
  @@index([organizationId, status])
  @@map("findings")
}

model CorrectiveActionPlan {
  id                 String     @id @default(cuid())
  findingId          String     @unique @map("finding_id")
  rootCauseEn        String     @map("root_cause_en")
  rootCauseFr        String     @map("root_cause_fr")
  correctiveActionEn String     @map("corrective_action_en")
  correctiveActionFr String     @map("corrective_action_fr")
  preventiveActionEn String?    @map("preventive_action_en")
  preventiveActionFr String?    @map("preventive_action_fr")
  status             CAPStatus  @default(DRAFT)
  assignedToId       String?    @map("assigned_to_id")
  submittedAt        DateTime?  @map("submitted_at")
  acceptedAt         DateTime?  @map("accepted_at")
  dueDate            DateTime   @map("due_date")
  completedAt        DateTime?  @map("completed_at")
  verifiedAt         DateTime?  @map("verified_at")
  verificationMethod String?    @map("verification_method")
  verificationNotes  String?    @map("verification_notes")
  verifiedById       String?    @map("verified_by_id")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")
  assignedTo         User?      @relation("AssignedTo", fields: [assignedToId], references: [id])
  finding            Finding    @relation(fields: [findingId], references: [id])
  documents          Document[]

  @@map("corrective_action_plans")
}

model TrainingModule {
  id            String             @id @default(cuid())
  moduleNumber  Int                @map("module_number")
  code          String             @unique
  titleEn       String             @map("title_en")
  titleFr       String             @map("title_fr")
  descriptionEn String             @map("description_en")
  descriptionFr String             @map("description_fr")
  objectivesEn  String[]           @default([]) @map("objectives_en")
  objectivesFr  String[]           @default([]) @map("objectives_fr")
  iconName      String?            @map("icon_name")
  sortOrder     Int                @map("sort_order")
  isActive      Boolean            @default(true) @map("is_active")
  isEnabled     Boolean            @default(true) @map("is_enabled")
  enabledUntil  DateTime?          @map("enabled_until")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  resources     TrainingResource[]
  topics        TrainingTopic[]

  @@map("training_modules")
}

model TrainingTopic {
  id                String           @id @default(cuid())
  moduleId          String           @map("module_id")
  titleEn           String           @map("title_en")
  titleFr           String           @map("title_fr")
  contentEn         String           @map("content_en")
  contentFr         String           @map("content_fr")
  relatedPQs        String[]         @default([]) @map("related_pqs")
  relatedStudyAreas CANSOStudyArea[] @default([]) @map("related_study_areas")
  sortOrder         Int              @map("sort_order")
  module            TrainingModule   @relation(fields: [moduleId], references: [id])

  @@map("training_topics")
}

model TrainingResource {
  id           String         @id @default(cuid())
  moduleId     String         @map("module_id")
  titleEn      String         @map("title_en")
  titleFr      String         @map("title_fr")
  resourceType ResourceType   @map("resource_type")
  url          String?
  fileUrl      String?        @map("file_url")
  sortOrder    Int            @map("sort_order")
  module       TrainingModule @relation(fields: [moduleId], references: [id])

  @@map("training_resources")
}

model Document {
  id             String           @id @default(cuid())
  name           String
  originalName   String?          @map("original_name")
  description    String?
  fileUrl        String           @map("file_url")
  fileType       String           @map("file_type")
  fileSize       Int              @map("file_size")
  category       DocumentCategory @default(EVIDENCE)
  tags           String[]         @default([])
  language       Locale?
  organizationId String?          @map("organization_id")
  assessmentId   String?          @map("assessment_id")
  reviewId       String?          @map("review_id")
  findingId      String?          @map("finding_id")
  capId          String?          @map("cap_id")
  uploadedById   String           @map("uploaded_by_id")
  uploadedAt     DateTime         @default(now()) @map("uploaded_at")
  isDeleted      Boolean          @default(false) @map("is_deleted")
  deletedAt      DateTime?        @map("deleted_at")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  // Relations
  assessment   Assessment?           @relation(fields: [assessmentId], references: [id])
  cap          CorrectiveActionPlan? @relation(fields: [capId], references: [id])
  finding      Finding?              @relation(fields: [findingId], references: [id])
  organization Organization?         @relation(fields: [organizationId], references: [id])
  review       Review?               @relation(fields: [reviewId], references: [id])
  uploadedBy   User                  @relation("UploadedDocuments", fields: [uploadedById], references: [id])
  responses    ResponseDocument[]

  @@index([organizationId, isDeleted])
  @@index([assessmentId])
  @@map("documents")
}

model ResponseDocument {
  id         String   @id @default(cuid())
  responseId String   @map("response_id")
  documentId String   @map("document_id")
  notes      String?
  addedAt    DateTime @default(now()) @map("added_at")
  addedById  String   @map("added_by_id")

  // Relations
  response AssessmentResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  document Document           @relation(fields: [documentId], references: [id], onDelete: Cascade)
  addedBy  User               @relation("AddedResponseDocuments", fields: [addedById], references: [id])

  @@unique([responseId, documentId])
  @@index([documentId])
  @@map("response_documents")
}

model Notification {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  type        String
  titleEn     String    @map("title_en")
  titleFr     String    @map("title_fr")
  messageEn   String    @map("message_en")
  messageFr   String    @map("message_fr")
  link        String?
  data        Json?
  readAt      DateTime? @map("read_at")
  emailSentAt DateTime? @map("email_sent_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId, readAt])
  @@map("notifications")
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?  @map("user_id")
  action       String
  entityType   String   @map("entity_type")
  entityId     String   @map("entity_id")
  previousData Json?    @map("previous_data")
  newData      Json?    @map("new_data")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User?    @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

enum Locale {
  EN
  FR
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum UserRole {
  SUPER_ADMIN
  SYSTEM_ADMIN
  STEERING_COMMITTEE
  PROGRAMME_COORDINATOR
  LEAD_REVIEWER
  PEER_REVIEWER
  OBSERVER
  ANSP_ADMIN
  SAFETY_MANAGER
  QUALITY_MANAGER
  STAFF
}

enum AfricanRegion {
  WACAF
  ESAF
  NORTHERN
}

enum MembershipStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum QuestionnaireType {
  ANS_USOAP_CMA
  SMS_CANSO_SOE
}

enum USOAPAuditArea {
  LEG
  ORG
  PEL
  OPS
  AIR
  AIG
  ANS
  AGA
  SSP
}

enum CriticalElement {
  CE_1
  CE_2
  CE_3
  CE_4
  CE_5
  CE_6
  CE_7
  CE_8
}

enum SMSComponent {
  SAFETY_POLICY_OBJECTIVES
  SAFETY_RISK_MANAGEMENT
  SAFETY_ASSURANCE
  SAFETY_PROMOTION
}

enum CANSOStudyArea {
  SA_1_1
  SA_1_2
  SA_1_3
  SA_1_4
  SA_1_5
  SA_2_1
  SA_2_2
  SA_3_1
  SA_3_2
  SA_3_3
  SA_4_1
  SA_4_2
}

enum TransversalArea {
  SPM
  HP
  CI
}

enum MaturityLevel {
  LEVEL_A
  LEVEL_B
  LEVEL_C
  LEVEL_D
  LEVEL_E
}

enum PQAmendmentStatus {
  NO_CHANGE
  REVISED
  NEW
  MERGED
  DELETED
  REFERENCE_REVISED
}

enum ResponseType {
  SATISFACTORY_NOT
  MATURITY_LEVEL
  YES_NO
  SCALE_1_5
  TEXT
  MULTI_SELECT
}

enum ICAOReferenceType {
  CC
  STD
  RP
  PANS
  GM
  Cir
  SUPPS
}

enum ReviewerStatus {
  NOMINATED
  SELECTED
  IN_TRAINING
  CERTIFIED
  LEAD_QUALIFIED
  INACTIVE
  RETIRED
}

// ============================================
// REVIEWER PROFILE MODULE - ENHANCED ENUMS
// ============================================

enum ReviewerSelectionStatus {
  NOMINATED // Initial nomination by ANSP
  UNDER_REVIEW // Being evaluated by Steering Committee
  SELECTED // Approved for reviewer pool
  INACTIVE // Temporarily inactive
  WITHDRAWN // Withdrawn from programme
  REJECTED // Not selected
}

enum ReviewerType {
  PEER_REVIEWER // Standard peer reviewer
  LEAD_REVIEWER // Can lead review teams
  SENIOR_REVIEWER // Experienced reviewer (5+ reviews)
  OBSERVER // In training/observation mode
}

enum ContactMethod {
  EMAIL
  PHONE
  WHATSAPP
  TEAMS
}

enum ProficiencyLevel {
  BASIC // Foundational knowledge
  COMPETENT // Working proficiency
  PROFICIENT // Advanced proficiency
  EXPERT // Subject matter expert
}

enum AvailabilityType {
  AVAILABLE // Fully available for assignment
  TENTATIVE // Possibly available (needs confirmation)
  UNAVAILABLE // Not available (blackout period)
  ON_ASSIGNMENT // Already assigned to a review
}

enum COIType {
  // Legacy values (existing in database)
  EMPLOYMENT
  FINANCIAL
  CONTRACTUAL
  PERSONAL
  PREVIOUS_REVIEW
  // New values
  HOME_ORGANIZATION // Reviewer's current employer - auto-detected
  FAMILY_RELATIONSHIP // Immediate family works at organization
  FORMER_EMPLOYEE // Worked there within 3 years
  BUSINESS_INTEREST // Financial/consulting ties
  RECENT_REVIEW // Reviewed within 2-year cooldown - auto-detected
  OTHER // Other declared conflicts
}

enum COISeverity {
  HARD_BLOCK // Cannot be overridden - reviewer ineligible
  SOFT_WARNING // Can be overridden with documented justification
}

enum ExpertiseArea {
  ATS
  AIM_AIS
  MET
  CNS
  PANS_OPS
  SAR
  SMS_POLICY
  SMS_RISK
  SMS_ASSURANCE
  SMS_PROMOTION
  AERODROME
  RFF
  ENGINEERING
  QMS
  TRAINING
  HUMAN_FACTORS
}

enum Language {
  EN
  FR
  AR
  PT
  ES
}

enum LanguageProficiency {
  BASIC
  INTERMEDIATE
  ADVANCED
  NATIVE
}

enum CertificationType {
  PEER_REVIEWER
  LEAD_REVIEWER
  SMS_ASSESSOR
  ICAO_AUDITOR
  CANSO_TRAINER
  ATC_LICENSE
  OTHER
}

enum TrainingType {
  INITIAL_REVIEWER
  REFRESHER
  LEAD_REVIEWER
  SMS_ASSESSMENT
  USOAP_CMA
  CANSO_SOE
  SPECIALIZED
}

enum TrainingStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  INCOMPLETE
  CANCELLED
}

enum AssessmentType {
  SELF_ASSESSMENT
  PEER_REVIEW
  GAP_ANALYSIS
  FOLLOW_UP
}

enum AssessmentStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  COMPLETED
  ARCHIVED
}

enum ReviewType {
  FULL
  FOCUSED
  FOLLOW_UP
  SURVEILLANCE
}

enum ReviewLocationType {
  ON_SITE
  REMOTE
  HYBRID
}

enum LanguagePreference {
  EN
  FR
  BOTH
}

enum ReviewStatus {
  REQUESTED
  APPROVED
  PLANNING
  SCHEDULED
  IN_PROGRESS
  REPORT_DRAFTING
  REPORT_REVIEW
  COMPLETED
  CANCELLED
}

enum ReviewPhase {
  PLANNING
  PREPARATION
  ON_SITE
  REPORTING
  FOLLOW_UP
  CLOSED
}

enum TeamRole {
  LEAD_REVIEWER
  REVIEWER
  TECHNICAL_EXPERT
  OBSERVER
  TRAINEE
}

enum FindingType {
  NON_CONFORMITY
  OBSERVATION
  RECOMMENDATION
  GOOD_PRACTICE
  CONCERN
}

enum FindingSeverity {
  CRITICAL
  MAJOR
  MINOR
  OBSERVATION
}

enum FindingStatus {
  OPEN
  CAP_REQUIRED
  CAP_SUBMITTED
  CAP_ACCEPTED
  IN_PROGRESS
  VERIFICATION
  CLOSED
  DEFERRED
}

enum CAPStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  IN_PROGRESS
  COMPLETED
  VERIFIED
  CLOSED
}

enum ResourceType {
  DOCUMENT
  VIDEO
  PRESENTATION
  CHECKLIST
  TEMPLATE
  EXTERNAL_LINK
}

enum DocumentCategory {
  POLICY
  PROCEDURE
  RECORD
  CERTIFICATE
  REPORT
  TRAINING
  EVIDENCE
  OTHER
}

enum EventType {
  CREATED
  STARTED
  RESPONSE_SAVED
  EVIDENCE_ADDED
  EVIDENCE_REMOVED
  STATUS_CHANGED
  SUBMITTED
  REVIEWED
  COMPLETED
  REOPENED
  COMMENT_ADDED
}
