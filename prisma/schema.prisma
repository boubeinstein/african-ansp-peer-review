generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id                  String              @id @default(cuid())
  nameEn              String              @map("name_en")
  nameFr              String              @map("name_fr")
  organizationCode    String?             @unique @map("organization_code")
  country             String
  region              AfricanRegion
  city                String?
  peerReviewTeam      Int?                @map("peer_review_team")
  membershipStatus    MembershipStatus    @default(PENDING)
  joinedAt            DateTime?           @map("joined_at")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  joinedProgrammeAt   DateTime?           @map("joined_programme_at")
  participationStatus ParticipationStatus @default(REGISTERED) @map("participation_status")
  regionalTeamId      String?             @map("regional_team_id")
  assessments         Assessment[]
  coiOverrides        COIOverride[]       @relation("COIOverrides")
  documents           Document[]
  findings            Finding[]
  joinRequests        JoinRequest[]
  conflictCOIs        ReviewerCOI[]       @relation("ConflictReviewers")
  homeReviewers       ReviewerProfile[]   @relation("HomeReviewers")
  reviewsAsHost       Review[]            @relation("HostANSP")
  users               User[]
  regionalTeam              RegionalTeam?            @relation("TeamMembers", fields: [regionalTeamId], references: [id])
  leadsTeam                 RegionalTeam?            @relation("TeamLead")
  bestPractices             BestPractice[]
  bestPracticeAdoptions     BestPracticeAdoption[]
  lessonsLearned            BestPracticeLessonLearned[]
  mentorshipRequestsSent    MentorshipRequest[] @relation("MentorshipRequesting")
  mentorshipRequestsReceived MentorshipRequest[] @relation("MentorshipTarget")

  @@map("organizations")
}

model RegionalTeam {
  id                  String         @id @default(cuid())
  teamNumber          Int            @unique @map("team_number")
  code                String         @unique
  nameEn              String         @map("name_en")
  nameFr              String         @map("name_fr")
  leadOrganizationId  String         @unique @map("lead_organization_id")
  leadOrganization    Organization   @relation("TeamLead", fields: [leadOrganizationId], references: [id])
  memberOrganizations Organization[] @relation("TeamMembers")
  isActive            Boolean        @default(true) @map("is_active")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  @@map("regional_teams")
}

model User {
  id                       String                 @id @default(cuid())
  email                    String                 @unique
  passwordHash             String?                @map("password_hash")
  emailVerified            DateTime?              @map("email_verified")
  firstName                String                 @map("first_name")
  lastName                 String                 @map("last_name")
  title                    String?
  phone                    String?
  locale                   Locale                 @default(EN)
  timezone                 String                 @default("UTC")
  theme                    Theme                  @default(SYSTEM)
  role                     UserRole               @default(STAFF)
  organizationId           String?                @map("organization_id")
  lastLoginAt              DateTime?              @map("last_login_at")
  isActive                 Boolean                @default(true) @map("is_active")
  mustChangePassword       Boolean                @default(false) @map("must_change_password")
  createdAt                DateTime               @default(now()) @map("created_at")
  updatedAt                DateTime               @updatedAt @map("updated_at")
  assessmentEvents         AssessmentEvent[]
  assessmentResponses      AssessmentResponse[]
  auditLogs                AuditLog[]
  approvedCOIOverrides     COIOverride[]          @relation("COIOverrideApprover")
  revokedCOIOverrides      COIOverride[]          @relation("COIOverrideRevoker")
  assignedCAPs             CorrectiveActionPlan[] @relation("AssignedTo")
  capComments              CAPComment[]           @relation("CAPCommentAuthor")
  uploadedEvidence         CAPEvidence[]          @relation("CAPEvidenceUploader")
  reviewedEvidence         CAPEvidence[]          @relation("CAPEvidenceReviewer")
  uploadedDocuments        Document[]             @relation("UploadedDocuments")
  assignedFindings         Finding[]              @relation("AssignedTo")
  coordinatorReviews       JoinRequest[]          @relation("CoordinatorReview")
  scDecisions              JoinRequest[]          @relation("SCDecision")
  notifications            Notification[]
  passwordResets           PasswordReset[]
  addedResponseDocuments   ResponseDocument[]     @relation("AddedResponseDocuments")
  reviewTeamMembers        ReviewTeamMember[]
  createdAvailabilitySlots ReviewerAvailability[] @relation("AvailabilityCreator")
  createdCOIs              ReviewerCOI[]          @relation("COICreator")
  verifiedCOIs             ReviewerCOI[]          @relation("COIVerifier")
  reviewerProfile          ReviewerProfile?
  reviewApprovals          ReviewApproval[]       @relation("ReviewApprovals")
  fieldworkChecklists      FieldworkChecklist[]   @relation("FieldworkChecklists")
  checklistItemsCompleted  FieldworkChecklistItem[] @relation("ChecklistCompletedBy")
  checklistItemsOverridden FieldworkChecklistItem[] @relation("ChecklistOverriddenBy")
  documentsReviewed        Document[]             @relation("DocumentReviewer")
  documentsApproved        Document[]             @relation("DocumentApprover")
  preferences              UserPreferences?
  organization             Organization?          @relation(fields: [organizationId], references: [id])
  submittedBestPractices   BestPractice[]         @relation("SubmittedBestPractices")
  reviewedBestPractices    BestPractice[]         @relation("ReviewedBestPractices")
  adoptedBestPractices     BestPracticeAdoption[] @relation("AdoptedBestPractices")
  lessonsAuthored          BestPracticeLessonLearned[] @relation("LessonsAuthored")
  bestPracticeComments     BestPracticeComment[]  @relation("BestPracticeCommentsAuthored")
  mentorshipRequests       MentorshipRequest[]    @relation("MentorshipRequester")
  retrospectives           ReviewRetrospective[]  @relation("RetrospectiveSubmitter")
  discussionsAuthored      ReviewDiscussion[]     @relation("DiscussionAuthor")
  discussionsResolved      ReviewDiscussion[]     @relation("ResolvedDiscussions")
  tasksAssigned            ReviewTask[]           @relation("AssignedTasks")
  tasksCreated             ReviewTask[]           @relation("CreatedTasks")
  tasksCompleted           ReviewTask[]           @relation("CompletedTasks")

  // Real-time collaboration
  sessionsStarted          ReviewSession[]        @relation("SessionStarter")
  sessionParticipations    SessionParticipant[]
  sessionActivities        SessionActivity[]
  documentAnnotations      DocumentAnnotation[]

  // Workflow automation
  workflowsCreated         WorkflowDefinition[]   @relation("WorkflowCreator")
  workflowActions          WorkflowHistory[]      @relation("WorkflowActor")

  // Notification preferences
  notificationPreference   NotificationPreference?
  notificationDigests      NotificationDigest[]

  // Evidence-grade documents
  documentVersionsCreated  DocumentVersion[]     @relation("VersionCreator")
  documentVersionsLocked   DocumentVersion[]     @relation("VersionLocker")
  evidenceLinksVerified    EvidenceLink[]        @relation("EvidenceVerifier")
  evidenceLinksCreated     EvidenceLink[]        @relation("EvidenceLinkCreator")
  documentTokensCreated    DocumentAccessToken[] @relation("TokenCreator")

  @@map("users")
}

model PasswordReset {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([expiresAt])
  @@map("password_resets")
}

model Questionnaire {
  id            String                  @id @default(cuid())
  code          String                  @unique
  type          QuestionnaireType
  version       String
  titleEn       String                  @map("title_en")
  titleFr       String                  @map("title_fr")
  descriptionEn String?                 @map("description_en")
  descriptionFr String?                 @map("description_fr")
  effectiveDate DateTime                @map("effective_date")
  expiryDate    DateTime?               @map("expiry_date")
  isActive      Boolean                 @default(true) @map("is_active")
  createdAt     DateTime                @default(now()) @map("created_at")
  updatedAt     DateTime                @updatedAt @map("updated_at")
  assessments   Assessment[]
  categories    QuestionnaireCategory[]
  questions     Question[]

  @@map("questionnaires")
}

model QuestionnaireCategory {
  id              String           @id @default(cuid())
  questionnaireId String           @map("questionnaire_id")
  code            String
  sortOrder       Int              @map("sort_order")
  nameEn          String           @map("name_en")
  nameFr          String           @map("name_fr")
  descriptionEn   String?          @map("description_en")
  descriptionFr   String?          @map("description_fr")
  auditArea       USOAPAuditArea?  @map("audit_area")
  criticalElement CriticalElement? @map("critical_element")
  smsComponent    SMSComponent?    @map("sms_component")
  studyArea       CANSOStudyArea?  @map("study_area")
  transversalArea TransversalArea? @map("transversal_area")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  questionnaire   Questionnaire    @relation(fields: [questionnaireId], references: [id])
  questions       Question[]

  @@unique([questionnaireId, code])
  @@map("questionnaire_categories")
}

model Question {
  id               String                @id @default(cuid())
  questionnaireId  String                @map("questionnaire_id")
  categoryId       String                @map("category_id")
  pqNumber         String?               @map("pq_number")
  auditArea        USOAPAuditArea?       @map("audit_area")
  criticalElement  CriticalElement?      @map("critical_element")
  isPriorityPQ     Boolean               @default(false) @map("is_priority_pq")
  requiresOnSite   Boolean               @default(false) @map("requires_on_site")
  pqStatus         PQAmendmentStatus     @default(NO_CHANGE) @map("pq_status")
  previousPqNumber String?               @map("previous_pq_number")
  smsComponent     SMSComponent?         @map("sms_component")
  studyArea        CANSOStudyArea?       @map("study_area")
  maturityLevel    MaturityLevel?        @map("maturity_level")
  questionTextEn   String                @map("question_text_en")
  questionTextFr   String                @map("question_text_fr")
  guidanceEn       String?               @map("guidance_en")
  guidanceFr       String?               @map("guidance_fr")
  responseType     ResponseType          @default(SATISFACTORY_NOT)
  requiredEvidence String[]              @default([])
  weight           Float                 @default(1.0)
  maxScore         Float                 @default(1.0) @map("max_score")
  sortOrder        Int                   @map("sort_order")
  isActive         Boolean               @default(true) @map("is_active")
  createdAt        DateTime              @default(now()) @map("created_at")
  updatedAt        DateTime              @updatedAt @map("updated_at")
  responses        AssessmentResponse[]
  findings         Finding[]
  icaoReferences   ICAOReference[]
  category         QuestionnaireCategory @relation(fields: [categoryId], references: [id])
  questionnaire    Questionnaire         @relation(fields: [questionnaireId], references: [id])

  @@unique([questionnaireId, pqNumber])
  @@index([auditArea, criticalElement])
  @@index([smsComponent, studyArea])
  @@map("questions")
}

model ICAOReference {
  id            String            @id @default(cuid())
  questionId    String            @map("question_id")
  referenceType ICAOReferenceType @map("reference_type")
  document      String
  chapter       String?
  description   String?
  question      Question          @relation(fields: [questionId], references: [id])

  @@map("icao_references")
}

model ReviewerProfile {
  id                     String                  @id @default(cuid())
  userId                 String                  @unique @map("user_id")
  organizationId         String                  @map("organization_id")
  status                 ReviewerStatus          @default(NOMINATED)
  nominatedAt            DateTime?               @map("nominated_at")
  selectedAt             DateTime?               @map("selected_at")
  certifiedAt            DateTime?               @map("certified_at")
  currentPosition        String                  @map("current_position")
  yearsExperience        Int                     @map("years_experience")
  biography              String?
  biographyFr            String?                 @map("biography_fr")
  expertiseAreas         ExpertiseArea[]         @default([])
  specializations        String[]                @default([])
  reviewsCompleted       Int                     @default(0) @map("reviews_completed")
  reviewsAsLead          Int                     @default(0) @map("reviews_as_lead")
  lastReviewDate         DateTime?               @map("last_review_date")
  isAvailable            Boolean                 @default(true) @map("is_available")
  availableFrom          DateTime?               @map("available_from")
  availableTo            DateTime?               @map("available_to")
  conflictOrganizations  String[]                @default([]) @map("conflict_organizations")
  averageRating          Float?                  @map("average_rating")
  feedbackCount          Int                     @default(0) @map("feedback_count")
  createdAt              DateTime                @default(now()) @map("created_at")
  updatedAt              DateTime                @updatedAt @map("updated_at")
  alternativeEmail       String?                 @map("alternative_email")
  alternativePhone       String?                 @map("alternative_phone")
  homeOrganizationId     String                  @map("home_organization_id")
  isLeadQualified        Boolean                 @default(false) @map("is_lead_qualified")
  leadQualifiedAt        DateTime?               @map("lead_qualified_at")
  passportCountry        String?                 @map("passport_country")
  preferredContactMethod ContactMethod           @default(EMAIL) @map("preferred_contact_method")
  reviewerType           ReviewerType            @default(PEER_REVIEWER) @map("reviewer_type")
  selectionStatus        ReviewerSelectionStatus @default(NOMINATED) @map("selection_status")
  travelRestrictions     String?                 @map("travel_restrictions")
  visaCountries          String[]                @default([]) @map("visa_countries")
  coiOverrides           COIOverride[]
  teamAssignments        ReviewTeamMember[]
  availabilityPeriods    ReviewerAvailability[]
  certifications         ReviewerCertification[]
  conflictsOfInterest    ReviewerCOI[]
  expertiseRecords       ReviewerExpertise[]
  languages              ReviewerLanguage[]
  homeOrganization       Organization            @relation("HomeReviewers", fields: [homeOrganizationId], references: [id])
  user                   User                    @relation(fields: [userId], references: [id])
  trainingRecords        ReviewerTraining[]

  @@index([homeOrganizationId])
  @@index([selectionStatus, reviewerType])
  @@index([isAvailable, selectionStatus])
  @@map("reviewer_profiles")
}

model ReviewerLanguage {
  id                   String              @id @default(cuid())
  reviewerProfileId    String              @map("reviewer_profile_id")
  language             Language
  proficiency          LanguageProficiency
  isNative             Boolean             @default(false) @map("is_native")
  canConductInterviews Boolean             @default(false) @map("can_conduct_interviews")
  canWriteReports      Boolean             @default(false) @map("can_write_reports")
  icaoAssessmentDate   DateTime?           @map("icao_assessment_date")
  icaoExpiryDate       DateTime?           @map("icao_expiry_date")
  icaoLevel            Int?                @map("icao_level")
  reviewerProfile      ReviewerProfile     @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  @@unique([reviewerProfileId, language])
  @@index([reviewerProfileId])
  @@map("reviewer_languages")
}

model ReviewerCertification {
  id                  String            @id @default(cuid())
  reviewerProfileId   String            @map("reviewer_profile_id")
  certificateNumber   String?           @map("certificate_number")
  expiryDate          DateTime?         @map("expiry_date")
  isValid             Boolean           @default(true) @map("is_valid")
  documentUrl         String?           @map("document_url")
  certificationName   String            @map("certification_name")
  certificationNameFr String?           @map("certification_name_fr")
  certificationType   CertificationType @map("certification_type")
  createdAt           DateTime          @default(now()) @map("created_at")
  issueDate           DateTime          @map("issue_date")
  issuingAuthority    String            @map("issuing_authority")
  updatedAt           DateTime          @updatedAt @map("updated_at")
  reviewerProfile     ReviewerProfile   @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  @@index([reviewerProfileId])
  @@index([certificationType])
  @@index([expiryDate])
  @@map("reviewer_certifications")
}

model ReviewerTraining {
  id                String          @id @default(cuid())
  reviewerProfileId String          @map("reviewer_profile_id")
  trainingType      TrainingType    @map("training_type")
  provider          String
  startDate         DateTime        @map("start_date")
  completionDate    DateTime?       @map("completion_date")
  status            TrainingStatus  @default(SCHEDULED)
  grade             String?
  location          String?
  isOnline          Boolean         @default(false) @map("is_online")
  certificateUrl    String?         @map("certificate_url")
  createdAt         DateTime        @default(now()) @map("created_at")
  hoursCompleted    Int?            @map("hours_completed")
  notes             String?
  trainingName      String          @map("training_name")
  trainingNameFr    String?         @map("training_name_fr")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  reviewerProfile   ReviewerProfile @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  @@index([reviewerProfileId])
  @@index([trainingType])
  @@index([status])
  @@map("reviewer_trainings")
}

model ReviewerExpertise {
  id                String           @id @default(cuid())
  reviewerProfileId String           @map("reviewer_profile_id")
  area              ExpertiseArea
  proficiencyLevel  ProficiencyLevel @default(COMPETENT) @map("proficiency_level")
  yearsExperience   Int              @default(0) @map("years_experience")
  isVerified        Boolean          @default(false) @map("is_verified")
  verifiedAt        DateTime?        @map("verified_at")
  verifiedBy        String?          @map("verified_by")
  description       String?
  descriptionFr     String?          @map("description_fr")
  certifications    String[]         @default([])
  canAssessANS      Boolean          @default(false) @map("can_assess_ans")
  canAssessSMS      Boolean          @default(false) @map("can_assess_sms")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  reviewerProfile   ReviewerProfile  @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  @@unique([reviewerProfileId, area])
  @@index([area, proficiencyLevel])
  @@map("reviewer_expertises")
}

model ReviewerAvailability {
  id                String           @id @default(cuid())
  reviewerProfileId String           @map("reviewer_profile_id")
  startDate         DateTime         @map("start_date")
  endDate           DateTime         @map("end_date")
  availabilityType  AvailabilityType @default(AVAILABLE) @map("availability_type")
  notes             String?
  isRecurring       Boolean          @default(false) @map("is_recurring")
  recurrencePattern String?          @map("recurrence_pattern")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  createdById       String?          @map("created_by_id")
  reviewId          String?          @map("review_id")
  title             String?
  createdBy         User?            @relation("AvailabilityCreator", fields: [createdById], references: [id])
  review            Review?          @relation(fields: [reviewId], references: [id])
  reviewerProfile   ReviewerProfile  @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  @@index([reviewerProfileId])
  @@index([startDate, endDate])
  @@index([availabilityType])
  @@index([reviewId])
  @@map("reviewer_availability")
}

model ReviewerCOI {
  id                String          @id @default(cuid())
  reviewerProfileId String          @map("reviewer_profile_id")
  organizationId    String          @map("organization_id")
  coiType           COIType         @map("coi_type")
  reason            String?
  startDate         DateTime        @default(now()) @map("start_date")
  endDate           DateTime?       @map("end_date")
  isActive          Boolean         @default(true) @map("is_active")
  verifiedById      String?         @map("verified_by_id")
  verifiedAt        DateTime?       @map("verified_at")
  verificationNotes String?         @map("verification_notes")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  autoDetectedAt    DateTime?       @map("auto_detected_at")
  createdById       String?         @map("created_by_id")
  isAutoDetected    Boolean         @default(false) @map("is_auto_detected")
  reasonEn          String?         @map("reason_en")
  reasonFr          String?         @map("reason_fr")
  severity          COISeverity     @default(SOFT_WARNING) @map("severity")
  createdBy         User?           @relation("COICreator", fields: [createdById], references: [id])
  organization      Organization    @relation("ConflictReviewers", fields: [organizationId], references: [id])
  reviewerProfile   ReviewerProfile @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)
  verifiedBy        User?           @relation("COIVerifier", fields: [verifiedById], references: [id])

  @@unique([reviewerProfileId, organizationId, coiType])
  @@index([organizationId])
  @@index([isActive])
  @@index([severity])
  @@index([isAutoDetected])
  @@map("reviewer_coi")
}

model COIOverride {
  id                String          @id @default(cuid())
  reviewerProfileId String          @map("reviewer_profile_id")
  organizationId    String          @map("organization_id")
  reviewId          String?         @map("review_id")
  justification     String
  approvedById      String          @map("approved_by_id")
  approvedAt        DateTime        @default(now()) @map("approved_at")
  expiresAt         DateTime?       @map("expires_at")
  isRevoked         Boolean         @default(false) @map("is_revoked")
  revokedAt         DateTime?       @map("revoked_at")
  revokedById       String?         @map("revoked_by_id")
  revokeReason      String?         @map("revoke_reason")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  approvedBy        User            @relation("COIOverrideApprover", fields: [approvedById], references: [id])
  organization      Organization    @relation("COIOverrides", fields: [organizationId], references: [id])
  review            Review?         @relation(fields: [reviewId], references: [id])
  reviewerProfile   ReviewerProfile @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)
  revokedBy         User?           @relation("COIOverrideRevoker", fields: [revokedById], references: [id])

  @@unique([reviewerProfileId, organizationId, reviewId])
  @@index([organizationId])
  @@index([approvedById])
  @@index([isRevoked])
  @@map("coi_override")
}

model Assessment {
  id                 String               @id @default(cuid())
  type               AssessmentType       @default(SELF_ASSESSMENT)
  title              String
  description        String?
  questionnaireId    String               @map("questionnaire_id")
  organizationId     String               @map("organization_id")
  status             AssessmentStatus     @default(DRAFT)
  progress           Float                @default(0)
  dueDate            DateTime?            @map("due_date")
  startedAt          DateTime?            @map("started_at")
  submittedAt        DateTime?            @map("submitted_at")
  completedAt        DateTime?            @map("completed_at")
  overallScore       Float?               @map("overall_score")
  maturityLevel      MaturityLevel?       @map("maturity_level")
  eiScore            Float?               @map("ei_score")
  categoryScores     Json?                @map("category_scores")
  reviewId           String?              @map("review_id")
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  referenceNumber    String?              @unique @map("reference_number")
  selectedAuditAreas USOAPAuditArea[]     @default([]) @map("selected_audit_areas")
  events             AssessmentEvent[]
  responses          AssessmentResponse[]
  organization       Organization         @relation(fields: [organizationId], references: [id])
  questionnaire      Questionnaire        @relation(fields: [questionnaireId], references: [id])
  review             Review?              @relation(fields: [reviewId], references: [id])
  documents          Document[]

  @@index([organizationId, questionnaireId])
  @@index([organizationId, status])
  @@index([status])
  @@index([createdAt])
  @@map("assessments")
}

model AssessmentEvent {
  id           String     @id @default(cuid())
  assessmentId String     @map("assessment_id")
  type         EventType
  description  String
  metadata     Json?
  userId       String     @map("user_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id])

  @@index([assessmentId, createdAt])
  @@map("assessment_events")
}

model AssessmentResponse {
  id            String             @id @default(cuid())
  assessmentId  String             @map("assessment_id")
  questionId    String             @map("question_id")
  responseValue String?            @map("response_value")
  maturityLevel MaturityLevel?     @map("maturity_level")
  score         Float?
  notes         String?
  evidenceUrls  String[]           @default([]) @map("evidence_urls")
  respondedById String?            @map("responded_by_id")
  respondedAt   DateTime?          @map("responded_at")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  assessment    Assessment         @relation(fields: [assessmentId], references: [id])
  question      Question           @relation(fields: [questionId], references: [id])
  respondedBy   User?              @relation(fields: [respondedById], references: [id])
  documents     ResponseDocument[]

  @@unique([assessmentId, questionId])
  @@index([assessmentId])
  @@index([questionId])
  @@map("assessment_responses")
}

model Review {
  id                     String                 @id @default(cuid())
  referenceNumber        String                 @unique @map("reference_number")
  reviewType             ReviewType             @default(FULL)
  hostOrganizationId     String                 @map("host_organization_id")
  status                 ReviewStatus           @default(REQUESTED)
  phase                  ReviewPhase            @default(PLANNING)
  requestedDate          DateTime               @map("requested_date")
  plannedStartDate       DateTime?              @map("planned_start_date")
  plannedEndDate         DateTime?              @map("planned_end_date")
  actualStartDate        DateTime?              @map("actual_start_date")
  actualEndDate          DateTime?              @map("actual_end_date")
  questionnairesInScope  String[]               @default([]) @map("questionnaires_in_scope")
  areasInScope           String[]               @default([]) @map("areas_in_scope")
  createdAt              DateTime               @default(now()) @map("created_at")
  updatedAt              DateTime               @updatedAt @map("updated_at")
  locationType           ReviewLocationType     @default(ON_SITE) @map("location_type")
  objectives             String?
  specialRequirements    String?                @map("special_requirements")
  accommodationProvided  Boolean                @default(false) @map("accommodation_provided")
  languagePreference     LanguagePreference     @default(BOTH) @map("language_preference")
  primaryContactEmail    String?                @map("primary_contact_email")
  primaryContactName     String?                @map("primary_contact_name")
  primaryContactPhone    String?                @map("primary_contact_phone")
  requestedEndDate       DateTime?              @map("requested_end_date")
  requestedStartDate     DateTime?              @map("requested_start_date")
  transportationProvided Boolean                @default(false) @map("transportation_provided")
  assessments            Assessment[]
  coiOverrides           COIOverride[]
  documents              Document[]
  findings               Finding[]
  report                 ReviewReport?
  teamMembers            ReviewTeamMember[]
  blockedAvailability    ReviewerAvailability[]
  approvals              ReviewApproval[]
  fieldworkChecklist     FieldworkChecklist?
  checklistItems         FieldworkChecklistItem[]
  hostOrganization       Organization           @relation("HostANSP", fields: [hostOrganizationId], references: [id])
  discussions            ReviewDiscussion[]
  tasks                  ReviewTask[]

  // Real-time collaboration
  sessions               ReviewSession[]

  // Post-review reflection (ICAO Annex 19 - Continuous Improvement)
  retrospective          ReviewRetrospective?

  @@map("reviews")
}

model ReviewApproval {
  id           String         @id @default(cuid())
  reviewId     String         @map("review_id")
  status       ApprovalStatus @default(PENDING)
  approvedById String?        @map("approved_by_id")
  approvedAt   DateTime?      @map("approved_at")
  commentsEn   String?        @map("comments_en") @db.Text
  commentsFr   String?        @map("comments_fr") @db.Text
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  review     Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  approvedBy User?  @relation("ReviewApprovals", fields: [approvedById], references: [id])

  @@unique([reviewId])
  @@map("review_approvals")
}

model ReviewTeamMember {
  id                String           @id @default(cuid())
  reviewId          String           @map("review_id")
  userId            String           @map("user_id")
  reviewerProfileId String?          @map("reviewer_profile_id")
  role              TeamRole         @default(REVIEWER)
  assignedAreas     String[]         @default([]) @map("assigned_areas")
  createdAt         DateTime         @default(now()) @map("created_at")

  // Invitation workflow
  invitationStatus  InvitationStatus @default(PENDING) @map("invitation_status")
  invitedAt         DateTime?        @map("invited_at")
  respondedAt       DateTime?        @map("responded_at")
  confirmedAt       DateTime?        @map("confirmed_at")
  declinedAt        DateTime?        @map("declined_at")
  declineReason     String?          @map("decline_reason")

  // Cross-team assignment (Rule 3 exception)
  isCrossTeamAssignment   Boolean   @default(false) @map("is_cross_team_assignment")
  crossTeamJustification  String?   @map("cross_team_justification") @db.Text
  crossTeamApprovedById   String?   @map("cross_team_approved_by_id")
  crossTeamApprovedAt     DateTime? @map("cross_team_approved_at")

  review            Review           @relation(fields: [reviewId], references: [id])
  reviewerProfile   ReviewerProfile? @relation(fields: [reviewerProfileId], references: [id])
  user              User             @relation(fields: [userId], references: [id])

  @@unique([reviewId, userId])
  @@index([userId, invitationStatus])
  @@map("review_team_members")
}

model FieldworkChecklist {
  id       String @id @default(cuid())
  reviewId String @unique @map("review_id")

  // Pre-visit checklist
  documentRequestSent Boolean @default(false) @map("document_request_sent")
  documentsReceived   Boolean @default(false) @map("documents_received")
  preVisitMeetingHeld Boolean @default(false) @map("pre_visit_meeting_held")
  reviewPlanApproved  Boolean @default(false) @map("review_plan_approved")

  // On-site checklist
  openingMeetingHeld     Boolean @default(false) @map("opening_meeting_held")
  interviewsCompleted    Boolean @default(false) @map("interviews_completed")
  facilitiesInspected    Boolean @default(false) @map("facilities_inspected")
  documentReviewComplete Boolean @default(false) @map("document_review_complete")
  findingsDiscussed      Boolean @default(false) @map("findings_discussed")
  closingMeetingHeld     Boolean @default(false) @map("closing_meeting_held")

  // Post-visit checklist
  findingsEntered      Boolean @default(false) @map("findings_entered")
  evidenceUploaded     Boolean @default(false) @map("evidence_uploaded")
  draftReportPrepared  Boolean @default(false) @map("draft_report_prepared")
  hostFeedbackReceived Boolean @default(false) @map("host_feedback_received")

  // Completion tracking
  completedAt   DateTime? @map("completed_at")
  completedById String?   @map("completed_by_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  review      Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  completedBy User?  @relation("FieldworkChecklists", fields: [completedById], references: [id])

  @@map("fieldwork_checklists")
}

// Fieldwork Checklist with Validation Rules (Enhanced)
model FieldworkChecklistItem {
  id            String         @id @default(cuid())

  reviewId      String         @map("review_id")
  review        Review         @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  phase         FieldworkPhase
  itemCode      String         @map("item_code")
  sortOrder     Int            @map("sort_order")

  labelEn       String         @map("label_en")
  labelFr       String         @map("label_fr")

  isCompleted   Boolean        @default(false) @map("is_completed")
  completedAt   DateTime?      @map("completed_at")
  completedById String?        @map("completed_by_id")
  completedBy   User?          @relation("ChecklistCompletedBy", fields: [completedById], references: [id])

  // JSON validation rules (e.g., requires document upload, depends on other items)
  validationRules Json?        @map("validation_rules")

  // Override workflow for exceptions
  isOverridden    Boolean      @default(false) @map("is_overridden")
  overrideReason  String?      @map("override_reason")
  overriddenById  String?      @map("overridden_by_id")
  overriddenBy    User?        @relation("ChecklistOverriddenBy", fields: [overriddenById], references: [id])
  overriddenAt    DateTime?    @map("overridden_at")

  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@unique([reviewId, itemCode])
  @@index([reviewId, phase])
  @@map("fieldwork_checklist_items")
}

model ReviewReport {
  id                 String         @id @default(cuid())
  reviewId           String         @unique @map("review_id")
  titleEn            String         @map("title_en")
  titleFr            String         @map("title_fr")
  executiveSummaryEn String?        @map("executive_summary_en")
  executiveSummaryFr String?        @map("executive_summary_fr")
  overallMaturity    MaturityLevel? @map("overall_maturity")
  overallEI          Float?         @map("overall_ei")
  status             String         @default("DRAFT")
  draftedAt          DateTime?      @map("drafted_at")
  reviewedAt         DateTime?      @map("reviewed_at")
  finalizedAt        DateTime?      @map("finalized_at")
  pdfUrl             String?        @map("pdf_url")
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")
  review             Review         @relation(fields: [reviewId], references: [id])

  @@map("review_reports")
}

model Finding {
  id                   String                @id @default(cuid())
  reviewId             String                @map("review_id")
  organizationId       String                @map("organization_id")
  questionId           String?               @map("question_id")
  referenceNumber      String                @unique @map("reference_number")
  findingType          FindingType           @default(OBSERVATION)
  severity             FindingSeverity       @default(MINOR)
  titleEn              String                @map("title_en")
  titleFr              String                @map("title_fr")
  descriptionEn        String                @map("description_en")
  descriptionFr        String                @map("description_fr")
  evidenceEn           String?               @map("evidence_en")
  evidenceFr           String?               @map("evidence_fr")
  icaoReference        String?               @map("icao_reference")
  criticalElement      CriticalElement?      @map("critical_element")
  status               FindingStatus         @default(OPEN)
  assignedToId         String?               @map("assigned_to_id")
  capRequired          Boolean               @default(true) @map("cap_required")
  identifiedAt         DateTime              @default(now()) @map("identified_at")
  targetCloseDate      DateTime?             @map("target_close_date")
  closedAt             DateTime?             @map("closed_at")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  correctiveActionPlan CorrectiveActionPlan?
  documents            Document[]
  assignedTo           User?                 @relation("AssignedTo", fields: [assignedToId], references: [id])
  organization         Organization          @relation(fields: [organizationId], references: [id])
  question             Question?             @relation(fields: [questionId], references: [id])
  review               Review                @relation(fields: [reviewId], references: [id])
  bestPractice         BestPractice?

  // Document annotations linked to this finding
  annotations          DocumentAnnotation[]

  // Retrospective lessons linked to this finding
  retrospectiveLinks   RetrospectiveFinding[]

  @@index([reviewId, status])
  @@index([organizationId, status])
  @@map("findings")
}

model CorrectiveActionPlan {
  id                 String         @id @default(cuid())
  findingId          String         @unique @map("finding_id")
  rootCauseEn        String         @map("root_cause_en")
  rootCauseFr        String         @map("root_cause_fr")
  correctiveActionEn String         @map("corrective_action_en")
  correctiveActionFr String         @map("corrective_action_fr")
  preventiveActionEn String?        @map("preventive_action_en")
  preventiveActionFr String?        @map("preventive_action_fr")
  status             CAPStatus      @default(DRAFT)
  assignedToId       String?        @map("assigned_to_id")
  submittedAt        DateTime?      @map("submitted_at")
  acceptedAt         DateTime?      @map("accepted_at")
  dueDate            DateTime       @map("due_date")
  completedAt        DateTime?      @map("completed_at")
  verifiedAt         DateTime?      @map("verified_at")
  verificationMethod String?        @map("verification_method")
  verificationNotes  String?        @map("verification_notes")
  verifiedById       String?        @map("verified_by_id")
  rejectionReason    String?        @map("rejection_reason")
  implementedAt      DateTime?      @map("implemented_at")
  closedAt           DateTime?      @map("closed_at")
  closedById         String?        @map("closed_by_id")
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")
  assignedTo         User?          @relation("AssignedTo", fields: [assignedToId], references: [id])
  finding            Finding        @relation(fields: [findingId], references: [id])
  documents          Document[]
  milestones         CAPMilestone[]
  comments           CAPComment[]
  evidence           CAPEvidence[]

  @@map("corrective_action_plans")
}

model CAPMilestone {
  id            String          @id @default(cuid())
  capId         String          @map("cap_id")
  titleEn       String          @map("title_en")
  titleFr       String?         @map("title_fr")
  descriptionEn String?         @map("description_en")
  descriptionFr String?         @map("description_fr")
  targetDate    DateTime        @map("target_date")
  completedDate DateTime?       @map("completed_date")
  status        MilestoneStatus @default(PENDING)
  sortOrder     Int             @default(0) @map("sort_order")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  cap           CorrectiveActionPlan @relation(fields: [capId], references: [id], onDelete: Cascade)
  evidence      CAPEvidence[]

  @@index([capId])
  @@index([targetDate])
  @@map("cap_milestones")
}

model CAPComment {
  id        String   @id @default(cuid())
  capId     String   @map("cap_id")
  authorId  String   @map("author_id")
  contentEn String   @db.Text @map("content_en")
  contentFr String?  @db.Text @map("content_fr")
  isInternal Boolean @default(false) @map("is_internal")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  cap       CorrectiveActionPlan @relation(fields: [capId], references: [id], onDelete: Cascade)
  author    User     @relation("CAPCommentAuthor", fields: [authorId], references: [id])

  @@index([capId])
  @@index([authorId])
  @@map("cap_comments")
}

model CAPEvidence {
  id                String          @id @default(cuid())
  capId             String          @map("cap_id")
  milestoneId       String?         @map("milestone_id")
  category          EvidenceCategory
  titleEn           String          @map("title_en")
  titleFr           String?         @map("title_fr")
  descriptionEn     String?         @db.Text @map("description_en")
  descriptionFr     String?         @db.Text @map("description_fr")
  evidenceDate      DateTime        @map("evidence_date")
  fileUrl           String          @map("file_url")
  fileName          String          @map("file_name")
  fileType          String          @map("file_type")
  fileSize          Int             @map("file_size")
  status            EvidenceStatus  @default(PENDING)
  uploadedById      String          @map("uploaded_by_id")
  uploadedAt        DateTime        @default(now()) @map("uploaded_at")
  reviewedById      String?         @map("reviewed_by_id")
  reviewedAt        DateTime?       @map("reviewed_at")
  reviewerCommentEn String?         @db.Text @map("reviewer_comment_en")
  reviewerCommentFr String?         @db.Text @map("reviewer_comment_fr")
  rejectionReason   String?         @db.Text @map("rejection_reason")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  cap               CorrectiveActionPlan @relation(fields: [capId], references: [id], onDelete: Cascade)
  milestone         CAPMilestone?   @relation(fields: [milestoneId], references: [id])
  uploadedBy        User            @relation("CAPEvidenceUploader", fields: [uploadedById], references: [id])
  reviewedBy        User?           @relation("CAPEvidenceReviewer", fields: [reviewedById], references: [id])

  @@index([capId])
  @@index([milestoneId])
  @@index([status])
  @@index([uploadedById])
  @@map("cap_evidence")
}

model TrainingModule {
  id            String             @id @default(cuid())
  moduleNumber  Int                @map("module_number")
  code          String             @unique
  titleEn       String             @map("title_en")
  titleFr       String             @map("title_fr")
  descriptionEn String             @map("description_en")
  descriptionFr String             @map("description_fr")
  objectivesEn  String[]           @default([]) @map("objectives_en")
  objectivesFr  String[]           @default([]) @map("objectives_fr")
  iconName      String?            @map("icon_name")
  sortOrder     Int                @map("sort_order")
  isActive      Boolean            @default(true) @map("is_active")
  isEnabled     Boolean            @default(true) @map("is_enabled")
  enabledUntil  DateTime?          @map("enabled_until")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  resources     TrainingResource[]
  topics        TrainingTopic[]

  @@map("training_modules")
}

model TrainingTopic {
  id                String           @id @default(cuid())
  moduleId          String           @map("module_id")
  titleEn           String           @map("title_en")
  titleFr           String           @map("title_fr")
  contentEn         String           @map("content_en")
  contentFr         String           @map("content_fr")
  relatedPQs        String[]         @default([]) @map("related_pqs")
  relatedStudyAreas CANSOStudyArea[] @default([]) @map("related_study_areas")
  sortOrder         Int              @map("sort_order")
  module            TrainingModule   @relation(fields: [moduleId], references: [id])

  @@map("training_topics")
}

model TrainingResource {
  id           String         @id @default(cuid())
  moduleId     String         @map("module_id")
  titleEn      String         @map("title_en")
  titleFr      String         @map("title_fr")
  resourceType ResourceType   @map("resource_type")
  url          String?
  fileUrl      String?        @map("file_url")
  sortOrder    Int            @map("sort_order")
  module       TrainingModule @relation(fields: [moduleId], references: [id])

  @@map("training_resources")
}

model Document {
  id             String                @id @default(cuid())
  name           String
  originalName   String?               @map("original_name")
  description    String?
  fileUrl        String                @map("file_url")
  fileType       String                @map("file_type")
  fileSize       Int                   @map("file_size")
  category       DocumentCategory      @default(EVIDENCE)
  tags           String[]              @default([])
  language       Locale?
  organizationId String?               @map("organization_id")
  assessmentId   String?               @map("assessment_id")
  reviewId       String?               @map("review_id")
  findingId      String?               @map("finding_id")
  capId          String?               @map("cap_id")
  uploadedById   String                @map("uploaded_by_id")
  uploadedAt     DateTime              @default(now()) @map("uploaded_at")
  isConfidential Boolean               @default(false) @map("is_confidential")
  isDeleted      Boolean               @default(false) @map("is_deleted")
  deletedAt      DateTime?             @map("deleted_at")

  // Document status workflow
  status         DocumentStatus        @default(UPLOADED)
  reviewedAt     DateTime?             @map("reviewed_at")
  reviewedById   String?               @map("reviewed_by_id")
  reviewedBy     User?                 @relation("DocumentReviewer", fields: [reviewedById], references: [id])
  reviewNotes    String?               @map("review_notes")
  approvedAt     DateTime?             @map("approved_at")
  approvedById   String?               @map("approved_by_id")
  approvedBy     User?                 @relation("DocumentApprover", fields: [approvedById], references: [id])

  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")
  assessment     Assessment?           @relation(fields: [assessmentId], references: [id])
  cap            CorrectiveActionPlan? @relation(fields: [capId], references: [id])
  finding        Finding?              @relation(fields: [findingId], references: [id])
  organization   Organization?         @relation(fields: [organizationId], references: [id])
  review         Review?               @relation(fields: [reviewId], references: [id])
  uploadedBy     User                  @relation("UploadedDocuments", fields: [uploadedById], references: [id])
  responses      ResponseDocument[]

  // Collaborative annotations
  annotations    DocumentAnnotation[]

  // Evidence-grade enhancements
  classification    DocumentClassification @default(SUPPORTING)
  expiresAt         DateTime?              @map("expires_at")
  expiryNotified    Boolean                @default(false) @map("expiry_notified")
  currentVersionId  String?                @map("current_version_id")

  // Version and evidence relations
  versions          DocumentVersion[]
  evidenceLinks     EvidenceLink[]
  accessTokens      DocumentAccessToken[]

  @@index([organizationId, isDeleted])
  @@index([assessmentId])
  @@index([expiresAt])
  @@map("documents")
}

model DocumentVersion {
  id            String        @id @default(cuid())
  documentId    String        @map("document_id")
  document      Document      @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Version info
  versionNumber Int           @map("version_number")

  // File storage
  fileUrl       String        @map("file_url")
  fileName      String        @map("file_name")
  fileSize      Int           @map("file_size")
  mimeType      String        @map("mime_type")

  // Integrity
  hashAlgorithm HashAlgorithm @default(SHA256) @map("hash_algorithm")
  fileHash      String        @map("file_hash")

  // Metadata
  changeNotes   String?       @map("change_notes") @db.Text

  // Audit
  createdAt     DateTime      @default(now()) @map("created_at")
  createdById   String        @map("created_by_id")
  createdBy     User          @relation("VersionCreator", fields: [createdById], references: [id])

  // Immutability flag
  isLocked      Boolean       @default(false) @map("is_locked")
  lockedAt      DateTime?     @map("locked_at")
  lockedById    String?       @map("locked_by_id")
  lockedBy      User?         @relation("VersionLocker", fields: [lockedById], references: [id])

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@map("document_versions")
}

model EvidenceLink {
  id             String    @id @default(cuid())
  documentId     String    @map("document_id")
  document       Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Link target
  entityType     String    @map("entity_type") // FINDING, CAP, ASSESSMENT_RESPONSE
  entityId       String    @map("entity_id")

  // Link metadata
  linkType       String    @default("SUPPORTS") @map("link_type") // SUPPORTS, PROVES, REFERENCES
  relevanceScore Float?    @map("relevance_score") // 0-1, for AI-suggested links

  // Verification
  isVerified     Boolean   @default(false) @map("is_verified")
  verifiedAt     DateTime? @map("verified_at")
  verifiedById   String?   @map("verified_by_id")
  verifiedBy     User?     @relation("EvidenceVerifier", fields: [verifiedById], references: [id])

  // Notes
  notesEn        String?   @map("notes_en") @db.Text
  notesFr        String?   @map("notes_fr") @db.Text

  createdAt      DateTime  @default(now()) @map("created_at")
  createdById    String    @map("created_by_id")
  createdBy      User      @relation("EvidenceLinkCreator", fields: [createdById], references: [id])

  @@unique([documentId, entityType, entityId])
  @@index([entityType, entityId])
  @@map("evidence_links")
}

model DocumentAccessToken {
  id             String    @id @default(cuid())
  documentId     String    @map("document_id")
  document       Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Token
  token          String    @unique

  // Access control
  permissions    String[]  @default(["VIEW"]) // VIEW, DOWNLOAD

  // Validity
  expiresAt      DateTime  @map("expires_at")
  maxAccesses    Int?      @map("max_accesses")
  accessCount    Int       @default(0) @map("access_count")

  // Recipient info
  recipientEmail String?   @map("recipient_email")
  recipientName  String?   @map("recipient_name")
  purpose        String?

  // Audit
  createdAt      DateTime  @default(now()) @map("created_at")
  createdById    String    @map("created_by_id")
  createdBy      User      @relation("TokenCreator", fields: [createdById], references: [id])
  lastAccessedAt DateTime? @map("last_accessed_at")
  revokedAt      DateTime? @map("revoked_at")

  @@index([token])
  @@index([expiresAt])
  @@map("document_access_tokens")
}

model ResponseDocument {
  id         String             @id @default(cuid())
  responseId String             @map("response_id")
  documentId String             @map("document_id")
  notes      String?
  addedAt    DateTime           @default(now()) @map("added_at")
  addedById  String             @map("added_by_id")
  addedBy    User               @relation("AddedResponseDocuments", fields: [addedById], references: [id])
  document   Document           @relation(fields: [documentId], references: [id], onDelete: Cascade)
  response   AssessmentResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@unique([responseId, documentId])
  @@index([documentId])
  @@map("response_documents")
}

model Notification {
  id             String               @id @default(cuid())
  userId         String               @map("user_id")
  type           NotificationType     @default(SYSTEM_ANNOUNCEMENT)
  titleEn        String               @map("title_en")
  titleFr        String               @map("title_fr")
  messageEn      String               @map("message_en")
  messageFr      String               @map("message_fr")
  entityType     String?              @map("entity_type")
  entityId       String?              @map("entity_id")
  actionUrl      String?              @map("action_url")
  actionLabelEn  String?              @map("action_label_en")
  actionLabelFr  String?              @map("action_label_fr")
  priority       NotificationPriority @default(NORMAL)
  link           String?
  data           Json?
  readAt         DateTime?            @map("read_at")
  emailSentAt    DateTime?            @map("email_sent_at")
  createdAt      DateTime             @default(now()) @map("created_at")
  user           User                 @relation(fields: [userId], references: [id])

  @@index([userId, readAt])
  @@index([userId, type])
  @@index([userId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@map("notifications")
}

model NotificationPreference {
  id                String              @id @default(cuid())
  userId            String              @unique @map("user_id")
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Global settings
  emailEnabled      Boolean             @default(true) @map("email_enabled")
  inAppEnabled      Boolean             @default(true) @map("in_app_enabled")
  digestFrequency   DigestFrequency     @default(IMMEDIATE) @map("digest_frequency")

  // Type-specific settings (JSON map of NotificationType -> boolean)
  typeSettings      Json                @default("{}") @map("type_settings")

  // Quiet hours (UTC)
  quietHoursStart   String?             @map("quiet_hours_start")
  quietHoursEnd     String?             @map("quiet_hours_end")
  timezone          String              @default("UTC")

  // Frequency capping
  maxPerHour        Int                 @default(10) @map("max_per_hour")
  maxPerDay         Int                 @default(50) @map("max_per_day")

  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  @@map("notification_preferences")
}

model NotificationDigest {
  id                String              @id @default(cuid())
  userId            String              @map("user_id")
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  frequency         DigestFrequency
  scheduledFor      DateTime            @map("scheduled_for")
  sentAt            DateTime?           @map("sent_at")

  // Aggregated notification IDs
  notificationIds   String[]            @map("notification_ids")

  createdAt         DateTime            @default(now()) @map("created_at")

  @@index([userId, frequency, scheduledFor])
  @@map("notification_digests")
}

model AuditLog {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  action        AuditAction
  entityType    String      @map("entity_type")
  entityId      String      @map("entity_id")
  previousState Json?       @map("previous_state")
  newState      Json?       @map("new_state")
  metadata      Json?
  ipAddress     String?     @map("ip_address")
  userAgent     String?     @map("user_agent")
  createdAt     DateTime    @default(now()) @map("created_at")
  user          User        @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================================
// WORKFLOW AUTOMATION MODELS
// =============================================================================

model WorkflowDefinition {
  id              String              @id @default(cuid())
  code            String              @unique
  nameEn          String              @map("name_en")
  nameFr          String              @map("name_fr")
  descriptionEn   String?             @map("description_en") @db.Text
  descriptionFr   String?             @map("description_fr") @db.Text
  entityType      WorkflowEntityType
  isActive        Boolean             @default(true) @map("is_active")
  isDefault       Boolean             @default(false) @map("is_default")
  version         Int                 @default(1)
  states          WorkflowState[]
  transitions     WorkflowTransition[]
  escalationRules EscalationRule[]
  executions      WorkflowExecution[]
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  createdById     String?             @map("created_by_id")
  createdBy       User?               @relation("WorkflowCreator", fields: [createdById], references: [id])

  @@index([entityType, isActive])
  @@map("workflow_definitions")
}

model WorkflowState {
  id                String              @id @default(cuid())
  workflowId        String              @map("workflow_id")
  workflow          WorkflowDefinition  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  code              String
  labelEn           String              @map("label_en")
  labelFr           String              @map("label_fr")
  stateType         WorkflowStateType   @default(INTERMEDIATE) @map("state_type")
  color             String?
  icon              String?
  sortOrder         Int                 @default(0) @map("sort_order")
  defaultSLADays    Int?                @map("default_sla_days")
  fromTransitions   WorkflowTransition[] @relation("FromState")
  toTransitions     WorkflowTransition[] @relation("ToState")
  escalationRules   EscalationRule[]

  @@unique([workflowId, code])
  @@map("workflow_states")
}

model WorkflowTransition {
  id                  String              @id @default(cuid())
  workflowId          String              @map("workflow_id")
  workflow            WorkflowDefinition  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  fromStateId         String              @map("from_state_id")
  fromState           WorkflowState       @relation("FromState", fields: [fromStateId], references: [id])
  toStateId           String              @map("to_state_id")
  toState             WorkflowState       @relation("ToState", fields: [toStateId], references: [id])
  code                String
  labelEn             String              @map("label_en")
  labelFr             String              @map("label_fr")
  trigger             TransitionTrigger   @default(MANUAL)
  allowedRoles        Json                @default("[]") @map("allowed_roles")
  conditions          Json?
  onTransitionActions Json?               @map("on_transition_actions")
  buttonVariant       String?             @map("button_variant")
  confirmRequired     Boolean             @default(false) @map("confirm_required")
  confirmMessageEn    String?             @map("confirm_message_en")
  confirmMessageFr    String?             @map("confirm_message_fr")

  @@unique([workflowId, fromStateId, code])
  @@map("workflow_transitions")
}

model EscalationRule {
  id                 String              @id @default(cuid())
  workflowId         String              @map("workflow_id")
  workflow           WorkflowDefinition  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stateId            String              @map("state_id")
  state              WorkflowState       @relation(fields: [stateId], references: [id])
  nameEn             String              @map("name_en")
  nameFr             String              @map("name_fr")
  triggerAfterDays   Int                 @map("trigger_after_days")
  triggerConditions  Json?               @map("trigger_conditions")
  action             EscalationAction
  actionConfig       Json?               @map("action_config")
  repeatIntervalDays Int?                @map("repeat_interval_days")
  maxRepeats         Int?                @map("max_repeats")
  isActive           Boolean             @default(true) @map("is_active")

  @@map("escalation_rules")
}

model WorkflowExecution {
  id               String              @id @default(cuid())
  workflowId       String              @map("workflow_id")
  workflow         WorkflowDefinition  @relation(fields: [workflowId], references: [id])
  entityType       WorkflowEntityType  @map("entity_type")
  entityId         String              @map("entity_id")
  currentStateCode String              @map("current_state_code")
  startedAt        DateTime            @default(now()) @map("started_at")
  completedAt      DateTime?           @map("completed_at")
  history          WorkflowHistory[]
  slaTrackers      SLATracker[]

  @@unique([entityType, entityId])
  @@index([workflowId, currentStateCode])
  @@map("workflow_executions")
}

model WorkflowHistory {
  id              String              @id @default(cuid())
  executionId     String              @map("execution_id")
  execution       WorkflowExecution   @relation(fields: [executionId], references: [id], onDelete: Cascade)
  fromStateCode   String?             @map("from_state_code")
  toStateCode     String              @map("to_state_code")
  transitionCode  String?             @map("transition_code")
  trigger         TransitionTrigger
  performedById   String?             @map("performed_by_id")
  performedBy     User?               @relation("WorkflowActor", fields: [performedById], references: [id])
  comment         String?             @db.Text
  metadata        Json?
  performedAt     DateTime            @default(now()) @map("performed_at")
  durationInState Int?                @map("duration_in_state")

  @@index([executionId, performedAt])
  @@map("workflow_history")
}

model SLATracker {
  id              String              @id @default(cuid())
  executionId     String              @map("execution_id")
  execution       WorkflowExecution   @relation(fields: [executionId], references: [id], onDelete: Cascade)
  stateCode       String              @map("state_code")
  targetDays      Int                 @map("target_days")
  startedAt       DateTime            @map("started_at")
  pausedAt        DateTime?           @map("paused_at")
  pausedDuration  Int                 @default(0) @map("paused_duration")
  dueAt           DateTime            @map("due_at")
  status          SLAStatus           @default(RUNNING)
  breachedAt      DateTime?           @map("breached_at")
  completedAt     DateTime?           @map("completed_at")
  escalationCount Int                 @default(0) @map("escalation_count")
  lastEscalatedAt DateTime?           @map("last_escalated_at")

  @@unique([executionId, stateCode])
  @@index([status, dueAt])
  @@map("sla_trackers")
}

model UserPreferences {
  id                       String          @id @default(cuid())
  userId                   String          @unique @map("user_id")
  locale                   Locale          @default(EN)
  theme                    Theme           @default(SYSTEM)
  dateFormat               String          @default("DD/MM/YYYY") @map("date_format")
  showTrainingModule       Boolean         @default(true) @map("show_training_module")
  compactView              Boolean         @default(false) @map("compact_view")
  emailNotifications       Boolean         @default(true) @map("email_notifications")
  notifyOnReviewAssignment Boolean         @default(true) @map("notify_review_assignment")
  notifyOnFindingCreated   Boolean         @default(true) @map("notify_finding_created")
  notifyOnCAPStatusChange  Boolean         @default(true) @map("notify_cap_status")
  notifyOnReportReady      Boolean         @default(true) @map("notify_report_ready")
  digestFrequency          DigestFrequency @default(IMMEDIATE) @map("digest_frequency")
  createdAt                DateTime        @default(now()) @map("created_at")
  updatedAt                DateTime        @updatedAt @map("updated_at")
  user                     User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model JoinRequest {
  id                         String            @id @default(cuid())
  requestType                JoinRequestType   @default(PROGRAMME_JOIN) @map("request_type")

  // For existing organizations (USER_ACCESS requests)
  organizationId             String?           @map("organization_id")

  // For new organizations (PROGRAMME_JOIN with free-text entry)
  organizationName           String?           @map("organization_name")
  organizationCountry        String?           @map("organization_country")
  organizationCode           String?           @map("organization_code")

  // Contact details
  contactName                String            @map("contact_name")
  contactEmail               String            @map("contact_email")
  contactPhone               String?           @map("contact_phone")
  contactJobTitle            String            @map("contact_job_title")

  // Application details
  currentSmsMaturity         String?           @map("current_sms_maturity")
  commitmentLetterUrl        String?           @map("commitment_letter_url")
  motivationStatement        String            @map("motivation_statement")
  preferredTeam              Int?              @map("preferred_team")
  preferredLanguage          String            @default("en") @map("preferred_language")
  proposedReviewerCount      Int               @default(2) @map("proposed_reviewer_count")
  additionalNotes            String?           @map("additional_notes")

  // Status and workflow
  status                     JoinRequestStatus @default(PENDING)
  coordinatorNotes           String?           @map("coordinator_notes")
  coordinatorReviewedAt      DateTime?         @map("coordinator_reviewed_at")
  coordinatorRecommendation  String?           @map("coordinator_recommendation")
  coordinatorRecommendedTeam Int?              @map("coordinator_recommended_team")
  coordinatorReviewedById    String?           @map("coordinator_reviewed_by_id")

  // SC decision
  scDecision                 String?           @map("sc_decision")
  scDecisionNotes            String?           @map("sc_decision_notes")
  scDecisionAt               DateTime?         @map("sc_decision_at")
  scDecisionById             String?           @map("sc_decision_by_id")
  scAssignedTeam             Int?              @map("sc_assigned_team")
  rejectionReason            String?           @map("rejection_reason")
  additionalInfoRequest      String?           @map("additional_info_request")

  // Timestamps
  createdAt                  DateTime          @default(now()) @map("created_at")
  updatedAt                  DateTime          @updatedAt @map("updated_at")

  // Relations
  coordinatorReviewedBy      User?             @relation("CoordinatorReview", fields: [coordinatorReviewedById], references: [id])
  organization               Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  scDecisionBy               User?             @relation("SCDecision", fields: [scDecisionById], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
  @@map("join_requests")
}

enum Locale {
  EN
  FR
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum UserRole {
  SUPER_ADMIN
  SYSTEM_ADMIN
  STEERING_COMMITTEE
  PROGRAMME_COORDINATOR
  LEAD_REVIEWER
  PEER_REVIEWER
  OBSERVER
  ANSP_ADMIN
  SAFETY_MANAGER
  QUALITY_MANAGER
  STAFF
}

enum AfricanRegion {
  WACAF
  ESAF
  NORTHERN
}

enum MembershipStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum ParticipationStatus {
  REGISTERED
  APPLIED
  UNDER_REVIEW
  APPROVED
  ACTIVE
  SUSPENDED
  REJECTED
}

enum JoinRequestStatus {
  PENDING
  COORDINATOR_REVIEW
  SC_REVIEW
  APPROVED
  REJECTED
  MORE_INFO
  WITHDRAWN
}

enum JoinRequestType {
  PROGRAMME_JOIN  // Non-member organization wants to join the programme
  USER_ACCESS     // User wants access to an existing member organization
}

enum QuestionnaireType {
  ANS_USOAP_CMA
  SMS_CANSO_SOE
}

enum USOAPAuditArea {
  LEG
  ORG
  PEL
  OPS
  AIR
  AIG
  ANS
  AGA
  SSP
}

enum CriticalElement {
  CE_1
  CE_2
  CE_3
  CE_4
  CE_5
  CE_6
  CE_7
  CE_8
}

enum SMSComponent {
  SAFETY_POLICY_OBJECTIVES
  SAFETY_RISK_MANAGEMENT
  SAFETY_ASSURANCE
  SAFETY_PROMOTION
}

enum CANSOStudyArea {
  SA_1_1
  SA_1_2
  SA_1_3
  SA_1_4
  SA_1_5
  SA_2_1
  SA_2_2
  SA_3_1
  SA_3_2
  SA_3_3
  SA_4_1
  SA_4_2
}

enum TransversalArea {
  SPM
  HP
  CI
}

enum MaturityLevel {
  LEVEL_A
  LEVEL_B
  LEVEL_C
  LEVEL_D
  LEVEL_E
}

enum PQAmendmentStatus {
  NO_CHANGE
  REVISED
  NEW
  MERGED
  DELETED
  REFERENCE_REVISED
}

enum ResponseType {
  SATISFACTORY_NOT
  MATURITY_LEVEL
  YES_NO
  SCALE_1_5
  TEXT
  MULTI_SELECT
}

enum ICAOReferenceType {
  CC
  STD
  RP
  PANS
  GM
  Cir
  SUPPS
}

enum ReviewerStatus {
  NOMINATED
  SELECTED
  IN_TRAINING
  CERTIFIED
  LEAD_QUALIFIED
  INACTIVE
  RETIRED
}

enum ReviewerSelectionStatus {
  NOMINATED
  UNDER_REVIEW
  SELECTED
  INACTIVE
  WITHDRAWN
  REJECTED
}

enum ReviewerType {
  PEER_REVIEWER
  LEAD_REVIEWER
  SENIOR_REVIEWER
  OBSERVER
}

enum ContactMethod {
  EMAIL
  PHONE
  WHATSAPP
  TEAMS
}

enum ProficiencyLevel {
  BASIC
  COMPETENT
  PROFICIENT
  EXPERT
}

enum AvailabilityType {
  AVAILABLE
  TENTATIVE
  UNAVAILABLE
  ON_ASSIGNMENT
}

enum COIType {
  EMPLOYMENT
  FINANCIAL
  CONTRACTUAL
  PERSONAL
  PREVIOUS_REVIEW
  OTHER
  HOME_ORGANIZATION
  FAMILY_RELATIONSHIP
  FORMER_EMPLOYEE
  BUSINESS_INTEREST
  RECENT_REVIEW
}

enum COISeverity {
  HARD_BLOCK
  SOFT_WARNING
}

enum ExpertiseArea {
  ATS
  AIM_AIS
  MET
  CNS
  PANS_OPS
  SAR
  SMS_POLICY
  SMS_RISK
  SMS_ASSURANCE
  SMS_PROMOTION
  AERODROME
  RFF
  ENGINEERING
  QMS
  TRAINING
  HUMAN_FACTORS
}

enum Language {
  EN
  FR
  AR
  PT
  ES
}

enum LanguageProficiency {
  BASIC
  INTERMEDIATE
  ADVANCED
  NATIVE
}

enum CertificationType {
  PEER_REVIEWER
  LEAD_REVIEWER
  SMS_ASSESSOR
  ICAO_AUDITOR
  CANSO_TRAINER
  ATC_LICENSE
  OTHER
}

enum TrainingType {
  INITIAL_REVIEWER
  REFRESHER
  LEAD_REVIEWER
  SMS_ASSESSMENT
  USOAP_CMA
  CANSO_SOE
  SPECIALIZED
}

enum TrainingStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  INCOMPLETE
  CANCELLED
}

enum AssessmentType {
  SELF_ASSESSMENT
  PEER_REVIEW
  GAP_ANALYSIS
  FOLLOW_UP
}

enum AssessmentStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  COMPLETED
  ARCHIVED
}

enum ReviewType {
  FULL
  FOCUSED
  FOLLOW_UP
  SURVEILLANCE
}

enum ReviewLocationType {
  ON_SITE
  REMOTE
  HYBRID
}

enum LanguagePreference {
  EN
  FR
  BOTH
}

enum ReviewStatus {
  REQUESTED
  APPROVED
  PLANNING
  SCHEDULED
  IN_PROGRESS
  REPORT_DRAFTING
  REPORT_REVIEW
  COMPLETED
  CANCELLED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  DEFERRED
}

enum ReviewPhase {
  PLANNING
  PREPARATION
  ON_SITE
  REPORTING
  FOLLOW_UP
  CLOSED
}

enum FieldworkPhase {
  PRE_VISIT
  ON_SITE
  POST_VISIT
}

enum TeamRole {
  LEAD_REVIEWER
  REVIEWER
  TECHNICAL_EXPERT
  OBSERVER
  TRAINEE
}

enum InvitationStatus {
  PENDING     // Initial state when member is added
  INVITED     // Invitation sent to reviewer
  CONFIRMED   // Reviewer accepted invitation
  DECLINED    // Reviewer declined invitation
  WITHDRAWN   // Coordinator withdrew the invitation
}

enum FindingType {
  NON_CONFORMITY
  OBSERVATION
  RECOMMENDATION
  GOOD_PRACTICE
  CONCERN
}

enum FindingSeverity {
  CRITICAL
  MAJOR
  MINOR
  OBSERVATION
}

enum FindingStatus {
  OPEN
  CAP_REQUIRED
  CAP_SUBMITTED
  CAP_ACCEPTED
  IN_PROGRESS
  VERIFICATION
  CLOSED
  DEFERRED
}

enum CAPStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  IN_PROGRESS
  COMPLETED
  VERIFIED
  CLOSED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
  CANCELLED
}

enum EvidenceCategory {
  PROCEDURE_UPDATE
  TRAINING_RECORD
  PHOTO
  REPORT
  OTHER
}

enum EvidenceStatus {
  PENDING
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  MORE_INFO_REQUIRED
}

enum ResourceType {
  DOCUMENT
  VIDEO
  PRESENTATION
  CHECKLIST
  TEMPLATE
  EXTERNAL_LINK
}

enum DocumentCategory {
  // General categories
  POLICY
  PROCEDURE
  RECORD
  CERTIFICATE
  REPORT
  TRAINING
  EVIDENCE
  OTHER
  // Review-specific categories
  PRE_VISIT_REQUEST
  HOST_SUBMISSION
  INTERVIEW_NOTES
  DRAFT_REPORT
  FINAL_REPORT
  CAP_EVIDENCE
  CORRESPONDENCE
}

enum DocumentStatus {
  UPLOADED
  UNDER_REVIEW
  REVIEWED
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

enum DocumentClassification {
  EVIDENCE
  SUPPORTING
  REFERENCE
  DRAFT
  TEMPLATE
  CORRESPONDENCE
}

enum HashAlgorithm {
  SHA256
  SHA512
  MD5
}

enum EventType {
  CREATED
  STARTED
  RESPONSE_SAVED
  EVIDENCE_ADDED
  EVIDENCE_REMOVED
  STATUS_CHANGED
  SUBMITTED
  REVIEWED
  COMPLETED
  REOPENED
  COMMENT_ADDED
}

enum DigestFrequency {
  IMMEDIATE
  DAILY
  WEEKLY
}

enum NotificationType {
  // Reviews
  REVIEW_REQUESTED
  REVIEW_APPROVED
  REVIEW_REJECTED
  TEAM_ASSIGNED
  TEAM_INVITATION
  TEAM_INVITATION_RESPONSE
  REVIEW_STATUS_CHANGED
  REVIEW_DATES_CONFIRMED
  REVIEW_SCHEDULED
  REVIEW_STARTED
  REVIEW_COMPLETED

  // Findings
  FINDING_CREATED
  FINDING_UPDATED

  // CAPs
  CAP_REQUIRED
  CAP_SUBMITTED
  CAP_ACCEPTED
  CAP_REJECTED
  CAP_DEADLINE_APPROACHING
  CAP_OVERDUE
  CAP_VERIFIED
  CAP_CLOSED

  // Reports
  REPORT_DRAFT_READY
  REPORT_SUBMITTED
  REPORT_APPROVED

  // System
  SYSTEM_ANNOUNCEMENT
  REMINDER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  APPROVAL
  REJECTION
  ASSIGNMENT
  SUBMISSION
  VERIFICATION
  LOGIN
  LOGOUT
  EXPORT
  VIEW_SENSITIVE
  INTEGRITY_CHECK
  VERSION_LOCK
  VERSION_UNLOCK
  TOKEN_CREATE
  TOKEN_ACCESS
  TOKEN_REVOKE
  TOKEN_REVOKE_ALL
}

// =============================================================================
// BEST PRACTICES LIBRARY
// =============================================================================

enum BestPracticeCategory {
  SAFETY_MANAGEMENT
  OPERATIONAL_EFFICIENCY
  TRAINING_COMPETENCY
  TECHNOLOGY_INNOVATION
  REGULATORY_COMPLIANCE
  STAKEHOLDER_ENGAGEMENT
}

enum BestPracticeStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}

enum LessonStatus {
  DRAFT
  PUBLISHED
}

enum MentorshipStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum RetrospectiveStatus {
  DRAFT
  SUBMITTED
  PUBLISHED
}

enum LessonType {
  BEST_PRACTICE_IDENTIFIED
  SYSTEMIC_ISSUE
  PROCESS_IMPROVEMENT
  TRAINING_GAP
  RESOURCE_CONSTRAINT
}

// =============================================================================
// REVIEWER COLLABORATION WORKSPACE
// =============================================================================

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model BestPractice {
  id                String              @id @default(cuid())
  referenceNumber   String              @unique @map("reference_number")

  // Source (optional link to finding that originated this)
  findingId         String?             @unique @map("finding_id")
  finding           Finding?            @relation(fields: [findingId], references: [id])

  // Originating organization
  organizationId    String              @map("organization_id")
  organization      Organization        @relation(fields: [organizationId], references: [id])

  // Submitted by
  submittedById     String              @map("submitted_by_id")
  submittedBy       User                @relation("SubmittedBestPractices", fields: [submittedById], references: [id])

  // Content (bilingual)
  titleEn           String              @map("title_en")
  titleFr           String              @map("title_fr")
  summaryEn         String              @db.Text @map("summary_en")
  summaryFr         String              @db.Text @map("summary_fr")
  descriptionEn     String              @db.Text @map("description_en")
  descriptionFr     String              @db.Text @map("description_fr")
  implementationEn  String              @db.Text @map("implementation_en")
  implementationFr  String              @db.Text @map("implementation_fr")
  benefitsEn        String              @db.Text @map("benefits_en")
  benefitsFr        String              @db.Text @map("benefits_fr")

  // Classification
  category          BestPracticeCategory
  auditArea         String?             @map("audit_area") // ATS, AIM, MET, CNS, SAR, SMS, etc.
  tags              String[]            @default([])

  // Media
  imageUrl          String?             @map("image_url")
  attachments       String[]            @default([])

  // Workflow status
  status            BestPracticeStatus  @default(DRAFT)
  submittedAt       DateTime?           @map("submitted_at")
  reviewedById      String?             @map("reviewed_by_id")
  reviewedBy        User?               @relation("ReviewedBestPractices", fields: [reviewedById], references: [id])
  reviewedAt        DateTime?           @map("reviewed_at")
  reviewNotes       String?             @db.Text @map("review_notes")
  publishedAt       DateTime?           @map("published_at")

  // Engagement metrics
  viewCount         Int                 @default(0) @map("view_count")

  // Adoptions
  adoptions         BestPracticeAdoption[]

  // Lessons learned from adopters
  lessonsLearned    BestPracticeLessonLearned[]

  // Discussion comments
  comments          BestPracticeComment[]

  // Mentorship requests
  mentorshipRequests MentorshipRequest[]

  // Timestamps
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([category])
  @@index([status])
  @@index([auditArea])
  @@index([publishedAt(sort: Desc)])
  @@map("best_practices")
}

model BestPracticeAdoption {
  id                  String        @id @default(cuid())

  bestPracticeId      String        @map("best_practice_id")
  bestPractice        BestPractice  @relation(fields: [bestPracticeId], references: [id], onDelete: Cascade)

  organizationId      String        @map("organization_id")
  organization        Organization  @relation(fields: [organizationId], references: [id])

  // Adoption details
  adoptedById         String        @map("adopted_by_id")
  adoptedBy           User          @relation("AdoptedBestPractices", fields: [adoptedById], references: [id])
  adoptedAt           DateTime      @default(now()) @map("adopted_at")

  // Implementation notes from adopting organization
  implementationNotes String?       @db.Text @map("implementation_notes")

  // Optional: track implementation status
  implementationStatus String?      @map("implementation_status") // PLANNED, IN_PROGRESS, COMPLETED
  completedAt         DateTime?     @map("completed_at")

  // Timestamps
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  @@unique([bestPracticeId, organizationId])
  @@index([organizationId])
  @@index([bestPracticeId])
  @@map("best_practice_adoptions")
}

model BestPracticeLessonLearned {
  id                       String       @id @default(cuid())

  bestPracticeId           String       @map("best_practice_id")
  bestPractice             BestPractice @relation(fields: [bestPracticeId], references: [id], onDelete: Cascade)

  organizationId           String       @map("organization_id")
  organization             Organization @relation(fields: [organizationId], references: [id])

  authorId                 String       @map("author_id")
  author                   User         @relation("LessonsAuthored", fields: [authorId], references: [id])

  // Content
  title                    String
  content                  String       @db.Text
  challengesFaced          String?      @db.Text @map("challenges_faced")
  keySuccessFactors        String?      @db.Text @map("key_success_factors")
  recommendations          String?      @db.Text

  // Metrics
  implementationDifficulty Int?         @map("implementation_difficulty") // 1-5
  overallEffectiveness     Int?         @map("overall_effectiveness")     // 1-5
  timeToImplementMonths    Int?         @map("time_to_implement_months")

  // Engagement
  helpfulCount             Int          @default(0) @map("helpful_count")

  // Status
  status                   LessonStatus @default(DRAFT)
  publishedAt              DateTime?    @map("published_at")

  // Timestamps
  createdAt                DateTime     @default(now()) @map("created_at")
  updatedAt                DateTime     @updatedAt @map("updated_at")

  @@index([bestPracticeId])
  @@index([organizationId])
  @@index([status])
  @@map("best_practice_lessons_learned")
}

model BestPracticeComment {
  id              String                @id @default(cuid())

  bestPracticeId  String                @map("best_practice_id")
  bestPractice    BestPractice          @relation(fields: [bestPracticeId], references: [id], onDelete: Cascade)

  authorId        String                @map("author_id")
  author          User                  @relation("BestPracticeCommentsAuthored", fields: [authorId], references: [id])

  // Threading support (one level)
  parentId        String?               @map("parent_id")
  parent          BestPracticeComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         BestPracticeComment[] @relation("CommentReplies")

  // Content
  content         String                @db.Text

  // Timestamps
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  @@index([bestPracticeId])
  @@index([parentId])
  @@map("best_practice_comments")
}

model MentorshipRequest {
  id                String            @id @default(cuid())

  bestPracticeId    String            @map("best_practice_id")
  bestPractice      BestPractice      @relation(fields: [bestPracticeId], references: [id], onDelete: Cascade)

  requestingOrgId   String            @map("requesting_org_id")
  requestingOrg     Organization      @relation("MentorshipRequesting", fields: [requestingOrgId], references: [id])

  targetOrgId       String            @map("target_org_id")
  targetOrg         Organization      @relation("MentorshipTarget", fields: [targetOrgId], references: [id])

  requesterId       String            @map("requester_id")
  requester         User              @relation("MentorshipRequester", fields: [requesterId], references: [id])

  // Request content
  message           String            @db.Text

  // Status
  status            MentorshipStatus  @default(PENDING)
  respondedAt       DateTime?         @map("responded_at")
  responseMessage   String?           @db.Text @map("response_message")

  // Timestamps
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  @@index([bestPracticeId])
  @@index([targetOrgId])
  @@index([requestingOrgId])
  @@map("mentorship_requests")
}

// =============================================================================
// REVIEW RETROSPECTIVE - ICAO Annex 19 Continuous Improvement
// =============================================================================

// Review Retrospective - captures post-review reflection
// Aligned with ICAO Annex 19 Section 3.3 (Continuous Improvement of SMS)
// and CANSO SoE SA8.1/SA10.1 (Safety Reporting & Improvement)
model ReviewRetrospective {
  id                      String              @id @default(cuid())

  reviewId                String              @unique @map("review_id")
  review                  Review              @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // Submitter info
  submittedById           String              @map("submitted_by_id")
  submittedBy             User                @relation("RetrospectiveSubmitter", fields: [submittedById], references: [id])
  submittedAt             DateTime            @default(now()) @map("submitted_at")

  // Section 1: Process Effectiveness
  processRating           Int                 @map("process_rating") // 1-5 scale
  preparationEffective    Boolean?            @map("preparation_effective")
  onSiteEffective         Boolean?            @map("on_site_effective")
  reportingEffective      Boolean?            @map("reporting_effective")

  // Section 2: What Went Well (Safety Assurance - positive findings)
  whatWentWell            String              @db.Text @map("what_went_well")

  // Section 3: Areas for Improvement (Continuous Improvement)
  areasForImprovement     String              @db.Text @map("areas_for_improvement")

  // Section 4: Key Learnings (Knowledge Management)
  keyLearnings            String              @db.Text @map("key_learnings")

  // Section 5: Programme Suggestions
  programmeSuggestions    String?             @db.Text @map("programme_suggestions")

  // Section 6: Quantitative Metrics
  reviewDurationDays      Int?                @map("review_duration_days")
  teamSizeAdequate        Boolean?            @map("team_size_adequate")
  resourcesAdequate       Boolean?            @map("resources_adequate")
  communicationEffective  Boolean?            @map("communication_effective")

  // Status workflow
  status                  RetrospectiveStatus @default(DRAFT)
  publishedAt             DateTime?           @map("published_at")

  // Timestamps
  createdAt               DateTime            @default(now()) @map("created_at")
  updatedAt               DateTime            @updatedAt @map("updated_at")

  // Related items tagged from retrospective
  taggedFindings          RetrospectiveFinding[]

  @@index([reviewId])
  @@index([submittedById])
  @@index([status])
  @@map("review_retrospectives")
}

// Link findings to retrospective insights for lessons learned
model RetrospectiveFinding {
  id                String              @id @default(cuid())

  retrospectiveId   String              @map("retrospective_id")
  retrospective     ReviewRetrospective @relation(fields: [retrospectiveId], references: [id], onDelete: Cascade)

  findingId         String              @map("finding_id")
  finding           Finding             @relation(fields: [findingId], references: [id])

  // Why this finding is notable
  notableReason     String?             @db.Text @map("notable_reason")
  lessonType        LessonType          @map("lesson_type")

  // Timestamps
  createdAt         DateTime            @default(now()) @map("created_at")

  @@unique([retrospectiveId, findingId])
  @@index([retrospectiveId])
  @@index([findingId])
  @@map("retrospective_findings")
}

// =============================================================================
// TRANSLATION CACHE
// =============================================================================

model TranslationCache {
  id              String   @id @default(cuid())
  sourceHash      String   @map("source_hash")
  sourceText      String   @map("source_text") @db.Text
  translatedText  String   @map("translated_text") @db.Text
  sourceLanguage  String   @map("source_language")
  targetLanguage  String   @map("target_language")
  entityType      String?  @map("entity_type")
  entityId        String?  @map("entity_id")
  fieldName       String?  @map("field_name")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([sourceHash, sourceLanguage, targetLanguage])
  @@index([entityType, entityId])
  @@map("translation_cache")
}

// =============================================================================
// REVIEWER COLLABORATION WORKSPACE - MODELS
// =============================================================================

model ReviewDiscussion {
  id              String              @id @default(cuid())

  // Parent review
  reviewId        String              @map("review_id")
  review          Review              @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // Author
  authorId        String              @map("author_id")
  author          User                @relation("DiscussionAuthor", fields: [authorId], references: [id])

  // Threading (optional parent for replies)
  parentId        String?             @map("parent_id")
  parent          ReviewDiscussion?   @relation("DiscussionReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         ReviewDiscussion[]  @relation("DiscussionReplies")

  // Content
  subject         String?             // Only for top-level discussions
  content         String              @db.Text

  // Mentions (stored as user IDs)
  mentions        String[]            @default([])

  // Attachments (URLs to uploaded files)
  attachments     String[]            @default([])

  // Status
  isResolved      Boolean             @default(false) @map("is_resolved")
  resolvedAt      DateTime?           @map("resolved_at")
  resolvedById    String?             @map("resolved_by_id")
  resolvedBy      User?               @relation("ResolvedDiscussions", fields: [resolvedById], references: [id])

  // Edit tracking
  isEdited        Boolean             @default(false) @map("is_edited")
  editedAt        DateTime?           @map("edited_at")

  // Soft delete
  isDeleted       Boolean             @default(false) @map("is_deleted")
  deletedAt       DateTime?           @map("deleted_at")

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Linked task (optional)
  linkedTask      ReviewTask?

  @@index([reviewId, isDeleted])
  @@index([reviewId, parentId])
  @@index([authorId])
  @@map("review_discussions")
}

model ReviewTask {
  id              String          @id @default(cuid())

  // Parent review
  reviewId        String          @map("review_id")
  review          Review          @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // Assignment
  assignedToId    String?         @map("assigned_to_id")
  assignedTo      User?           @relation("AssignedTasks", fields: [assignedToId], references: [id])
  createdById     String          @map("created_by_id")
  createdBy       User            @relation("CreatedTasks", fields: [createdById], references: [id])

  // Task details
  title           String
  description     String?         @db.Text

  // Status and priority
  status          TaskStatus      @default(PENDING)
  priority        TaskPriority    @default(MEDIUM)

  // Dates
  dueDate         DateTime?       @map("due_date")
  completedAt     DateTime?       @map("completed_at")
  completedById   String?         @map("completed_by_id")
  completedBy     User?           @relation("CompletedTasks", fields: [completedById], references: [id])

  // Checklist items (JSON array)
  checklist       Json?           // [{ id, text, completed }]

  // Linked discussion (optional)
  discussionId    String?         @unique @map("discussion_id")
  discussion      ReviewDiscussion? @relation(fields: [discussionId], references: [id])

  // Timestamps
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  @@index([reviewId, status])
  @@index([assignedToId, status])
  @@index([reviewId, dueDate])
  @@map("review_tasks")
}

// =============================================================================
// REAL-TIME COLLABORATION
// =============================================================================

/// Tracks active collaboration sessions for a review
model ReviewSession {
  id             String              @id @default(cuid())
  reviewId       String              @map("review_id")
  review         Review              @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // Session metadata
  sessionType    SessionType         @default(FIELDWORK) @map("session_type")
  title          String?
  description    String?

  // Timing
  startedAt      DateTime            @default(now()) @map("started_at")
  endedAt        DateTime?           @map("ended_at")
  scheduledStart DateTime?           @map("scheduled_start")
  scheduledEnd   DateTime?           @map("scheduled_end")

  // Session state
  status         SessionStatus       @default(ACTIVE)
  isRecording    Boolean             @default(false) @map("is_recording")

  // Creator
  startedById    String              @map("started_by_id")
  startedBy      User                @relation("SessionStarter", fields: [startedById], references: [id])

  // Participants
  participants   SessionParticipant[]
  activities     SessionActivity[]

  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")

  @@index([reviewId])
  @@index([status])
  @@map("review_sessions")
}

enum SessionType {
  FIELDWORK       // On-site review session
  REMOTE          // Remote collaboration
  DOCUMENT_REVIEW // Document review session
  DEBRIEF         // Team debrief
  PLANNING        // Planning session
}

enum SessionStatus {
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

/// Tracks participants in a collaboration session
model SessionParticipant {
  id            String          @id @default(cuid())
  sessionId     String          @map("session_id")
  session       ReviewSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  userId        String          @map("user_id")
  user          User            @relation(fields: [userId], references: [id])

  // Presence info
  joinedAt      DateTime        @default(now()) @map("joined_at")
  leftAt        DateTime?       @map("left_at")
  isOnline      Boolean         @default(true) @map("is_online")
  lastSeenAt    DateTime        @default(now()) @map("last_seen_at")

  // Current focus
  currentFocus  String?         @map("current_focus") // e.g., "finding:123", "document:456"
  cursorPosition Json?          @map("cursor_position") // {x, y, element}

  // Role in session
  role          ParticipantRole @default(PARTICIPANT)

  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("session_participants")
}

enum ParticipantRole {
  HOST        // Session host (usually team lead)
  PRESENTER   // Currently presenting/leading
  PARTICIPANT // Active participant
  OBSERVER    // View-only
}

/// Activity log for audit trail and session replay
model SessionActivity {
  id           String        @id @default(cuid())
  sessionId    String        @map("session_id")
  session      ReviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  userId       String        @map("user_id")
  user         User          @relation(fields: [userId], references: [id])

  // Activity details
  activityType ActivityType  @map("activity_type")
  targetType   String?       @map("target_type") // "finding", "document", "comment", etc.
  targetId     String?       @map("target_id")

  // Activity data
  data         Json?         // Flexible storage for activity-specific data
  previousData Json?         @map("previous_data") // For tracking changes

  // Metadata
  timestamp    DateTime      @default(now())
  ipAddress    String?       @map("ip_address")
  userAgent    String?       @map("user_agent")

  @@index([sessionId])
  @@index([userId])
  @@index([timestamp])
  @@index([activityType])
  @@map("session_activities")
}

enum ActivityType {
  // Session activities
  SESSION_JOIN
  SESSION_LEAVE
  SESSION_PAUSE
  SESSION_RESUME

  // Content activities
  FINDING_VIEW
  FINDING_CREATE
  FINDING_EDIT
  FINDING_DELETE

  COMMENT_ADD
  COMMENT_EDIT
  COMMENT_DELETE

  DOCUMENT_VIEW
  DOCUMENT_UPLOAD
  DOCUMENT_ANNOTATE

  // Collaboration activities
  CURSOR_MOVE
  SELECTION_CHANGE
  FOCUS_CHANGE

  // Task activities
  TASK_CREATE
  TASK_UPDATE
  TASK_COMPLETE
}

/// Collaborative document annotations
model DocumentAnnotation {
  id          String         @id @default(cuid())
  documentId  String         @map("document_id")
  document    Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Position
  pageNumber  Int            @map("page_number")
  x           Float
  y           Float
  width       Float?
  height      Float?

  // Annotation content
  type        AnnotationType
  content     String?
  color       String         @default("#FFEB3B")

  // Creator
  createdById String         @map("created_by_id")
  createdBy   User           @relation(fields: [createdById], references: [id])

  // Session context (if created during session)
  sessionId   String?        @map("session_id")

  // Link to finding if annotation supports a finding
  findingId   String?        @map("finding_id")
  finding     Finding?       @relation(fields: [findingId], references: [id])

  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  @@index([documentId])
  @@index([findingId])
  @@map("document_annotations")
}

enum AnnotationType {
  HIGHLIGHT
  COMMENT
  DRAWING
  STAMP
  TEXT
}

// =============================================================================
// WORKFLOW AUTOMATION ENUMS
// =============================================================================

enum WorkflowEntityType {
  CAP
  FINDING
  REVIEW
}

enum WorkflowStateType {
  INITIAL
  INTERMEDIATE
  TERMINAL
  REJECTED
}

enum TransitionTrigger {
  MANUAL
  AUTOMATIC
  SCHEDULED
  SLA_BREACH
}

enum EscalationAction {
  NOTIFY
  REASSIGN
  ESCALATE
  AUTO_REJECT
  AUTO_CLOSE
}

enum SLAStatus {
  NOT_STARTED
  RUNNING
  PAUSED
  BREACHED
  COMPLETED
}
